
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="title" content="Machine Learning Toolkit">
<meta name="description" content="A Python package with command-line utilities and scripts to aid the development of machine learning models for Silicon Lab's embedded platforms">
<meta name="keywords" content="machine learning, machine-learning, machinelearning, ml, ai, iot, Internet of things, aiot, tinyml, tensorflow, tensorflow-lite, tensorflow-lite-micro, keras-tensorflow, keras, tflite, embedded, embedded-systems, mcu, Microcontrollers, hardware, python, c++, cmake, keras, numpy, silabs, silicon labs">
<meta name="robots" content="index, follow">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="language" content="English">
<meta name="author" content="Silicon Labs">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HZ5MW943WF"></script>
<script>
    window.gTrackingId = 'G-HZ5MW943WF';
</script>
<meta name="google-site-verification" content="dsSsmnE2twOnfSAQk5zBBTrjMArsTJj809Bp-8mVlIw" />
  
  
    <title>siamese_contrastive &#8212; MLTK 0.17.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/custom.js"></script>
    <script src="../../../../_static/js/apitoc.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Silicon Labâ€™s Models" href="../siliconlabs/index.html" />
    <link rel="prev" title="autoencoder_example" href="autoencoder_example.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=red data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#docs/python_api/models/examples/siamese_contrastive" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../../index.html" title="MLTK 0.17.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../../../../_static/logo.png"
                   alt="MLTK 0.17.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Machine Learning Toolkit</span>
          <span class="md-header-nav__topic"> siamese_contrastive </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="https://docs.silabs.com/gecko-platform/latest/machine-learning/tensorflow/overview" class="md-tabs__link">Gecko SDK Documentation</a></li>
            
            <li class="md-tabs__item"><a href="https://github.com/tensorflow/tflite-micro" class="md-tabs__link">Tensorflow-Lite Micro Repository</a></li>
            
            <li class="md-tabs__item"><a href="https://www.tensorflow.org/learn" class="md-tabs__link">Tensorflow Documentation</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Reference Models</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Example Models</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../../index.html" title="MLTK 0.17.0 documentation" class="md-nav__button md-logo">
      
        <img src="../../../../_static/logo.png" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../../index.html"
       title="MLTK 0.17.0 documentation">Machine Learning Toolkit</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Basics</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../overview.html" class="md-nav__link">Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../why_mltk.html" class="md-nav__link">Why MLTK?</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../installation.html" class="md-nav__link">Installation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../command_line/index.html" class="md-nav__link">Command-Line</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/index.html" class="md-nav__link">Modeling Guides</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Usage</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../tutorials.html" class="md-nav__link">Tutorials</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../examples.html" class="md-nav__link">API Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../index.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../index.html" class="md-nav__link">Reference Models</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">Example Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../siliconlabs/index.html" class="md-nav__link">Silicon Labâ€™s Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tinyml/index.html" class="md-nav__link">TinyML Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tflite_micro/index.html" class="md-nav__link">Tensorflow-Lite Micro Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../common_models.html" class="md-nav__link">Common Model Architectures</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../datasets/index.html" class="md-nav__link">Reference Datasets</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/index.html" class="md-nav__link">C++ Development</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/examples/index.html" class="md-nav__link">C++ Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Audio Related</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/keyword_spotting_overview.html" class="md-nav__link">Keyword Spotting Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_feature_generator.html" class="md-nav__link">Audio Feature Generator</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_utilities.html" class="md-nav__link">Audio Utilities</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Other Information</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../faq/index.html" class="md-nav__link">Frequently Asked Questions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/quick_reference.html" class="md-nav__link">Quick Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/supported_hardware.html" class="md-nav__link">Supported Hardware</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/notebook_examples_guide.html" class="md-nav__link">Notebook Examples Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/settings_file.html" class="md-nav__link">Settings File</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/environment_variables.html" class="md-nav__link">Environment Variables</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="" id="localtoc">
        <li class="md-nav__item"><a href="#docs-python-api-models-examples-siamese-contrastive--page-root" class="md-nav__link">siamese_contrastive</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#commands" class="md-nav__link">Commands</a>
        </li>
        <li class="md-nav__item"><a href="#model-summary" class="md-nav__link">Model Summary</a>
        </li>
        <li class="md-nav__item"><a href="#model-diagram" class="md-nav__link">Model Diagram</a>
        </li>
        <li class="md-nav__item"><a href="#model-specification" class="md-nav__link">Model Specification</a>
        </li></ul>
            </nav>
        </li>
      <script type="text/javascript" src=../../../../_static/js/apitoc.js></script>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">

          
          <div class="breadcrumbs md-typeset">
            <ul class="breadcrumb">
              <li></li>
              <li><a href="../../../../index.html"><i class="md-icon">home</i></a></li>
                <li><a href="../index.html" >Reference Models</a></li>
                <li><a href="index.html" accesskey="U">Example Models</a></li>

              <li class="activate"><a>siamese_contrastive</a></li>
            </ul>
          </div>
          

          <article class="md-content__inner md-typeset" role="main">
            
  <span class="target" id="module-mltk.models.examples.siamese_contrastive"></span><section id="siamese-contrastive">
<h1 id="docs-python-api-models-examples-siamese-contrastive--page-root">siamese_contrastive<a class="headerlink" href="#docs-python-api-models-examples-siamese-contrastive--page-root" title="Permalink to this heading">Â¶</a></h1>
<p>Source code: <a class="reference external" href="https://github.com/siliconlabs/mltk/blob/master/mltk/models/examples/siamese_contrastive.py">siamese_contrastive.py</a></p>
<p>This example was adapted from <a class="reference external" href="https://keras.io/examples/vision/siamese_contrastive">https://keras.io/examples/vision/siamese_contrastive</a>.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Siamese_neural_network">Siamese Networks</a> are neural networks which share weights between two or more sister networks,
each producing embedding vectors of its respective inputs.</p>
<p>In supervised similarity learning, the networks are then trained to maximize the contrast (distance) between embeddings of inputs of different classes,
while minimizing the distance between embeddings of similar classes, resulting in embedding spaces that reflect the class segmentation of the training inputs.</p>
<section id="commands">
<h2 id="commands">Commands<a class="headerlink" href="#commands" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a "dry run" test training of the model</span>
mltk<span class="w"> </span>train<span class="w"> </span>siamese_contrastive-test

<span class="c1"># Train the model</span>
mltk<span class="w"> </span>train<span class="w"> </span>siamese_contrastive

<span class="c1"># Evaluate the trained model .tflite model</span>
mltk<span class="w"> </span>evaluate<span class="w"> </span>siamese_contrastive<span class="w"> </span>--tflite

<span class="c1"># Profile the model in the MVP hardware accelerator simulator</span>
mltk<span class="w"> </span>profile<span class="w"> </span>siamese_contrastive<span class="w"> </span>--accelerator<span class="w"> </span>MVP

<span class="c1"># Profile the model on a physical development board</span>
mltk<span class="w"> </span>profile<span class="w"> </span>siamese_contrastive<span class="w"> </span>--accelerator<span class="w"> </span>MVP<span class="w"> </span>--device

<span class="c1"># Directly invoke the model script</span>
python<span class="w"> </span>siamese_contrastive.py
</pre></div>
</div>
</section>
<section id="model-summary">
<h2 id="model-summary">Model Summary<a class="headerlink" href="#model-summary" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w">  </span>mltk<span class="w"> </span>summarize<span class="w"> </span>siamese_contrastive<span class="w"> </span>--tflite<span class="w"> </span>--build

+-------+-----------------+-------------------+----------------+-----------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Index<span class="w"> </span><span class="p">|</span><span class="w"> </span>OpCode<span class="w">          </span><span class="p">|</span><span class="w"> </span>Input<span class="o">(</span>s<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span>Output<span class="o">(</span>s<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span>Config<span class="w">                                              </span><span class="p">|</span>
+-------+-----------------+-------------------+----------------+-----------------------------------------------------+
<span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>quantize<span class="w">        </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>float32<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>quantize<span class="w">        </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>float32<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:none<span class="w">            </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>5x5x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>12x12x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">5</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>12x12x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:none<span class="w">            </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>5x5x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">6</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">7</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>4x4x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">8</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>reshape<span class="w">         </span><span class="p">|</span><span class="w"> </span>4x4x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">9</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>28x28x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:none<span class="w">            </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>5x5x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">11</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span>24x24x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>12x12x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">12</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>12x12x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:none<span class="w">            </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>5x5x4<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">13</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">14</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span>8x8x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>4x4x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">15</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>reshape<span class="w">         </span><span class="p">|</span><span class="w"> </span>4x4x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span>Activation:none<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">17</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">18</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>quantize<span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">19</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span>Activation:none<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">256</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>tanh<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">21</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>quantize<span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">22</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>concatenation<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">10</span><span class="w">                               </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">23</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span>Activation:relu<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">24</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w"> </span>Activation:relu<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">64</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">25</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span>Activation:none<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w">                </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">26</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>logistic<span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">27</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>dequantize<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span>float32<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="nv">BuiltinOptionsType</span><span class="o">=</span><span class="m">0</span><span class="w">                                </span><span class="p">|</span>
+-------+-----------------+-------------------+----------------+-----------------------------------------------------+
Total<span class="w"> </span>MACs:<span class="w"> </span><span class="m">327</span>.440<span class="w"> </span>k
Total<span class="w"> </span>OPs:<span class="w"> </span><span class="m">676</span>.823<span class="w"> </span>k
Name:<span class="w"> </span>siamese_contrastive
Version:<span class="w"> </span><span class="m">1</span>
Description:<span class="w"> </span>Image<span class="w"> </span>similarity<span class="w"> </span>estimation<span class="w"> </span>using<span class="w"> </span>a<span class="w"> </span>Siamese<span class="w"> </span>Network<span class="w"> </span>with<span class="w"> </span>a<span class="w"> </span>contrastive<span class="w"> </span>loss
classes:<span class="w"> </span><span class="o">[]</span>
hash:<span class="w"> </span>400f59a4a68872982f23f08a9de3fe92
date:<span class="w"> </span><span class="m">2022</span>-02-04T18:55:43.645Z
runtime_memory_size:<span class="w"> </span><span class="m">11368</span>
.tflite<span class="w"> </span>file<span class="w"> </span>size:<span class="w"> </span><span class="m">17</span>.4kB
</pre></div>
</div>
</section>
<section id="model-diagram">
<h2 id="model-diagram">Model Diagram<a class="headerlink" href="#model-diagram" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mltk<span class="w"> </span>view<span class="w"> </span>siamese_contrastive<span class="w"> </span>--tflite<span class="w"> </span>--build
</pre></div>
</div>
<div class="model-diagram">
<a href="../../../../_images/models/siamese_contrastive.tflite.png" target="_blank">
<img src="../../../../_images/models/siamese_contrastive.tflite.png"/>
<p>Click to enlarge</p>
</a>
</div></section>
<section id="model-specification">
<h2 id="model-specification">Model Specification<a class="headerlink" href="#model-specification" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">mltk.core</span> <span class="k">as</span> <span class="nn">mltk_core</span>
<span class="kn">from</span> <span class="nn">mltk.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_tflite_or_keras_model</span><span class="p">,</span>
    <span class="n">KerasModel</span><span class="p">,</span>
    <span class="n">TfliteModel</span><span class="p">,</span>
    <span class="n">EvaluationResults</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mltk.core.tflite_model.tflite_model</span> <span class="kn">import</span> <span class="n">TfliteModel</span>
<span class="kn">from</span> <span class="nn">mltk.datasets.image</span> <span class="kn">import</span> <span class="n">mnist</span>



<span class="c1"># Instantiate the MltkModel object with the following 'mixins':</span>
<span class="c1"># - TrainMixin            - Provides classifier model training operations and settings</span>
<span class="c1"># - DatasetMixin          - Generic data generation operations and settings</span>
<span class="c1"># @mltk_model # NOTE: This tag is required for this model be discoverable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">MltkModel</span><span class="p">,</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">TrainMixin</span><span class="p">,</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">DatasetMixin</span><span class="p">,</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">EvaluateMixin</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">test</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>

        <span class="p">(</span><span class="n">x_train_val</span><span class="p">,</span> <span class="n">y_train_val</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

        <span class="c1"># Change the data type to a floating point format</span>
        <span class="n">x_train_val</span> <span class="o">=</span> <span class="n">x_train_val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float32"</span><span class="p">)</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float32"</span><span class="p">)</span>

        <span class="c1"># Keep 50% of train_val  in validation set</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">x_val</span> <span class="o">=</span> <span class="n">x_train_val</span><span class="p">[:</span><span class="mi">30000</span><span class="p">],</span> <span class="n">x_train_val</span><span class="p">[</span><span class="mi">30000</span><span class="p">:]</span>
        <span class="n">y_train</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_train_val</span><span class="p">[:</span><span class="mi">30000</span><span class="p">],</span> <span class="n">y_train_val</span><span class="p">[</span><span class="mi">30000</span><span class="p">:]</span>
        <span class="k">del</span> <span class="n">x_train_val</span><span class="p">,</span> <span class="n">y_train_val</span>

        <span class="c1"># If we're testing, then just use a small subset</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="o">*</span><span class="mi">3</span>
            <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">[:</span><span class="n">l</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">l</span><span class="p">]</span>
            <span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="o">=</span> <span class="n">x_val</span><span class="p">[:</span><span class="n">l</span><span class="p">],</span> <span class="n">y_val</span><span class="p">[:</span><span class="n">l</span><span class="p">]</span>
            <span class="c1">#x_test, y_test = x_test[:32], y_test[:32]</span>

        <span class="c1"># make train pairs</span>
        <span class="n">pairs_train</span><span class="p">,</span> <span class="n">labels_train</span> <span class="o">=</span> <span class="n">make_pairs</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="c1"># pairs_train.shape = (60000, 2, 28, 28)</span>
        <span class="c1"># We have 60,000 pairs</span>
        <span class="c1"># Each pair contains 2 images</span>
        <span class="c1"># Each image has shape (28, 28)</span>
        <span class="n">x_train_1</span> <span class="o">=</span> <span class="n">pairs_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x_train_1.shape is (60000, 28, 28)</span>
        <span class="n">x_train_2</span> <span class="o">=</span> <span class="n">pairs_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># make validation pairs</span>
        <span class="n">pairs_val</span><span class="p">,</span> <span class="n">labels_val</span> <span class="o">=</span> <span class="n">make_pairs</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
        <span class="n">x_val_1</span> <span class="o">=</span> <span class="n">pairs_val</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x_val_1.shape = (60000, 28, 28)</span>
        <span class="n">x_val_2</span> <span class="o">=</span> <span class="n">pairs_val</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># make test pairs</span>
        <span class="n">pairs_test</span><span class="p">,</span> <span class="n">labels_test</span> <span class="o">=</span> <span class="n">make_pairs</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
        <span class="n">x_test_1</span> <span class="o">=</span> <span class="n">pairs_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># x_test_1.shape = (20000, 28, 28)</span>
        <span class="n">x_test_2</span> <span class="o">=</span> <span class="n">pairs_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">'evaluation'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_test_1</span><span class="p">,</span> <span class="n">x_test_2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">labels_test</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_train_1</span><span class="p">,</span> <span class="n">x_train_2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">labels_train</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_data</span> <span class="o">=</span> <span class="p">([</span><span class="n">x_val_1</span><span class="p">,</span> <span class="n">x_val_2</span><span class="p">],</span> <span class="n">labels_val</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_pairs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Creates a tuple containing image pairs with corresponding label.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x: List containing images, each index in this list corresponds to one image.</span>
<span class="sd">        y: List containing labels, each label with datatype of `int`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple containing two numpy arrays as (pairs_of_samples, labels),</span>
<span class="sd">        where pairs_of_samples' shape is (2len(x), 2,n_features_dims) and</span>
<span class="sd">        labels are a binary array of shape (2len(x)).</span>
<span class="sd">    """</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">digit_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)]</span>

    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="c1"># add a matching example</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="n">label1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">digit_indices</span><span class="p">[</span><span class="n">label1</span><span class="p">])</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>

        <span class="n">pairs</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]]</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># add a non-matching example</span>
        <span class="n">label2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">label2</span> <span class="o">==</span> <span class="n">label1</span><span class="p">:</span>
            <span class="n">label2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">idx2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">digit_indices</span><span class="p">[</span><span class="n">label2</span><span class="p">])</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>

        <span class="n">pairs</span> <span class="o">+=</span> <span class="p">[[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]]</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"float32"</span><span class="p">)</span>




<span class="k">class</span> <span class="nc">ContrastiveLoss</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">Loss</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">margin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Calculates the contrastive loss.</span>

<span class="sd">        Contrastive loss = mean( (1-true_value) * square(prediction) +</span>
<span class="sd">        true_value * square( max(margin-prediction, 0) ))</span>

<span class="sd">        Arguments:</span>

<span class="sd">        margin: Integer, defines the baseline for distance for which pairs</span>
<span class="sd">                should be classified as dissimilar. - (default is 1).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tensor containing contrastive loss as floating point value.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ContrastiveLoss</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Arguments:</span>
<span class="sd">            y_true: List of labels, each label is of type float32.</span>
<span class="sd">            y_pred: List of predictions of same length as of y_true,</span>
<span class="sd">                    each label is of type float32.</span>
<span class="sd">        """</span>
        <span class="n">square_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">margin_square</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">-</span> <span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span> <span class="o">*</span> <span class="n">square_pred</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">*</span> <span class="n">margin_square</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Returns the config dictionary for a `Loss` instance."""</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">'reduction'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'margin'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin</span><span class="p">}</span>



<span class="c1"># Provided two tensors t1 and t2</span>
<span class="c1"># Euclidean distance = sqrt(sum(square(t1-t2)))</span>
<span class="k">def</span> <span class="nf">euclidean_distance</span><span class="p">(</span><span class="n">vects</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Find the Euclidean distance between two vectors.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        vects: List containing two tensors of same length.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor containing euclidean distance</span>
<span class="sd">        (as floating point value) between vectors.</span>
<span class="sd">    """</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">vects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">vects</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sum_square</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sum_square</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">epsilon</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">my_model_builder</span><span class="p">(</span><span class="n">my_model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">):</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"tanh"</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"tanh"</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"tanh"</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">embedding_network</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


    <span class="n">input_1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">input_2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="c1"># As mentioned above, Siamese Network share weights between</span>
    <span class="c1"># tower networks (sister networks). To allow this, we will use</span>
    <span class="c1"># same embedding network for both tower networks.</span>
    <span class="n">tower_1</span> <span class="o">=</span> <span class="n">embedding_network</span><span class="p">(</span><span class="n">input_1</span><span class="p">)</span>
    <span class="n">tower_2</span> <span class="o">=</span> <span class="n">embedding_network</span><span class="p">(</span><span class="n">input_2</span><span class="p">)</span>


    <span class="c1"># Technically, we should be calculating the euclidean distance</span>
    <span class="c1"># as a model layer.</span>
    <span class="c1"># However, TFLM doesn't not support the SQUARED_DIFFERENCE kernel</span>
    <span class="c1"># So, as a work-around, we just use a dense layer to emulate it</span>

    <span class="c1">#merge_layer = layers.Lambda(euclidean_distance)([tower_1, tower_2])</span>
    <span class="c1">#normal_layer = tf.keras.layers.BatchNormalization()(merge_layer)</span>

    <span class="n">conc</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()([</span><span class="n">tower_1</span><span class="p">,</span> <span class="n">tower_2</span><span class="p">])</span>
    <span class="n">dense_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"relu"</span><span class="p">)(</span><span class="n">conc</span><span class="p">)</span>
    <span class="n">normal_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"relu"</span><span class="p">)(</span><span class="n">dense_1</span><span class="p">)</span>

    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"sigmoid"</span><span class="p">)(</span><span class="n">normal_layer</span><span class="p">)</span>
    <span class="n">keras_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">input_1</span><span class="p">,</span> <span class="n">input_2</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">metrics</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">keras_model</span>


<span class="k">def</span> <span class="nf">my_model_evaluator</span><span class="p">(</span>
    <span class="n">my_model</span><span class="p">:</span><span class="n">MyModel</span><span class="p">,</span>
    <span class="n">built_model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">KerasModel</span><span class="p">,</span> <span class="n">TfliteModel</span><span class="p">],</span>
    <span class="n">eval_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvaluationResults</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">EvaluationResults</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">built_model</span><span class="p">,</span> <span class="n">KerasModel</span><span class="p">):</span>
        <span class="n">eval_loss</span><span class="p">,</span> <span class="n">eval_accuracy</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">'overall_accuracy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">eval_accuracy</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">y</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">my_model</span><span class="o">.</span><span class="n">test_mode_enabled</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">tflite_interpreter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Interpreter</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="n">built_model</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">input_tensors</span> <span class="o">=</span> <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
        <span class="n">output_tensor</span> <span class="o">=</span> <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">new_input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span>
        <span class="n">new_output_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output_tensor</span><span class="p">[</span><span class="s1">'shape'</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">for</span> <span class="n">input_tensor</span> <span class="ow">in</span> <span class="n">input_tensors</span><span class="p">:</span>
            <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">resize_tensor_input</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">[</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">new_input_shape</span><span class="p">)</span>
        <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">resize_tensor_input</span><span class="p">(</span><span class="n">output_tensor</span><span class="p">[</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">new_output_shape</span><span class="p">)</span>

        <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">allocate_tensors</span><span class="p">()</span>

        <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n_correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">batch_size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">x1_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">x2_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="n">input_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">x1_batch</span><span class="p">)</span>
            <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">set_tensor</span><span class="p">(</span><span class="n">input_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">x2_batch</span><span class="p">)</span>
            <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">invoke</span><span class="p">()</span>

            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">tflite_interpreter</span><span class="o">.</span><span class="n">get_tensor</span><span class="p">(</span><span class="n">output_tensor</span><span class="p">[</span><span class="s1">'index'</span><span class="p">])</span>
            <span class="n">n_samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_pred</span><span class="p">):</span>
                <span class="c1"># If the prediction is within 20% of the actual</span>
                <span class="c1"># then we consider it correct</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pred</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">.2</span><span class="p">:</span>
                    <span class="n">n_correct</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="n">results</span><span class="p">[</span><span class="s1">'overall_accuracy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_correct</span> <span class="o">/</span> <span class="n">n_samples</span>


    <span class="k">return</span> <span class="n">results</span>



<span class="n">my_model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">'Image similarity estimation using a Siamese Network with a contrastive loss'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">ContrastiveLoss</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s1">'RMSprop'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">build_model_function</span> <span class="o">=</span> <span class="n">my_model_builder</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">eval_custom_function</span> <span class="o">=</span> <span class="n">my_model_evaluator</span>

<span class="c1"># We need to save reference to the custom loss function</span>
<span class="c1"># so that we can load the .h5 file</span>
<span class="c1"># See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">keras_custom_objects</span><span class="p">[</span><span class="s1">'ContrastiveLoss'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContrastiveLoss</span>



<span class="c1">#################################################</span>
<span class="c1"># TF-Lite converter settings</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'optimizations'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'DEFAULT'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'supported_ops'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'TFLITE_BUILTINS_INT8'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'inference_input_type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'float32'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'inference_output_type'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'float32'</span>
 <span class="c1"># generate a representative dataset from the validation data</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'representative_dataset'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'generate'</span>
<span class="c1"># generate a representative dataset from the validation data</span>
<span class="k">def</span> <span class="nf">my_representative_dataset_generator</span><span class="p">():</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">x</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_1</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_1</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_2</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">retval</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">])</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">batch_size</span>
    <span class="k">return</span> <span class="n">retval</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'representative_dataset'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_representative_dataset_generator</span>








<span class="c1">#################################################</span>
<span class="c1"># Custom Commands</span>




<span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">to_show</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">num_col</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Creates a plot of pairs and labels, and prediction if it's test dataset.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        pairs: List if input samples,</span>
<span class="sd">               [(Number of pairs, 28, 28), (Number of pairs, 28, 28)]</span>
<span class="sd">        to_show: Int, number of examples to visualize (default is 6)</span>
<span class="sd">                `to_show` must be an integral multiple of `num_col`.</span>
<span class="sd">                 Otherwise it will be trimmed if it is greater than num_col,</span>
<span class="sd">                 and incremented if if it is less then num_col.</span>
<span class="sd">        num_col: Int, number of images in one row - (default is 3)</span>
<span class="sd">                 For test and train respectively, it should not exceed 3 and 7.</span>
<span class="sd">        predictions: Numpy Array of predictions with shape (to_show, 1) -</span>
<span class="sd">                     (default is None)</span>
<span class="sd">                     Must be passed when test=True.</span>
<span class="sd">        test: Boolean telling whether the dataset being visualized is</span>
<span class="sd">              train dataset or test dataset - (default False).</span>

<span class="sd">    Returns:</span>
<span class="sd">        None.</span>
<span class="sd">    """</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


    <span class="c1"># Define num_row</span>
    <span class="c1"># If to_show % num_col != 0</span>
    <span class="c1">#    trim to_show,</span>
    <span class="c1">#       to trim to_show limit num_row to the point where</span>
    <span class="c1">#       to_show % num_col == 0</span>
    <span class="c1">#</span>
    <span class="c1"># If to_show//num_col == 0</span>
    <span class="c1">#    then it means num_col is greater then to_show</span>
    <span class="c1">#    increment to_show</span>
    <span class="c1">#       to increment to_show set num_row to 1</span>
    <span class="n">num_row</span> <span class="o">=</span> <span class="n">to_show</span> <span class="o">//</span> <span class="n">num_col</span> <span class="k">if</span> <span class="n">to_show</span> <span class="o">//</span> <span class="n">num_col</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="c1"># `to_show` must be an integral multiple of `num_col`</span>
    <span class="c1">#  we found num_row and we have num_col</span>
    <span class="c1">#  to increment or decrement to_show</span>
    <span class="c1">#  to make it integral multiple of `num_col`</span>
    <span class="c1">#  simply set it equal to num_row * num_col</span>
    <span class="n">to_show</span> <span class="o">=</span> <span class="n">num_row</span> <span class="o">*</span> <span class="n">num_col</span>

    <span class="c1"># Plot the images</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_row</span><span class="p">,</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">to_show</span><span class="p">):</span>

        <span class="c1"># If the number of rows is 1, the axes array is one-dimensional</span>
        <span class="k">if</span> <span class="n">num_row</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="n">num_col</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="n">num_col</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"True: </span><span class="si">{}</span><span class="s2"> | Pred: </span><span class="si">{:.5f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Label: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="c1"># if test:</span>
    <span class="c1">#     plt.tight_layout(rect=(0, 0, 1.9, 1.9), w_pad=0.0)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     plt.tight_layout(rect=(0, 0, 1.5, 1.5))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Register the "visualize" custom command</span>
<span class="kn">import</span> <span class="nn">typer</span>

<span class="nd">@my_model</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">'visualize'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visualize_custom_command</span><span class="p">(</span>
    <span class="n">predict</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">'--predict'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Include the trained model predictions in the displayed results'</span>
    <span class="p">),</span>
    <span class="n">count</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'--count'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Number of samples to display'</span>
    <span class="p">),</span>
    <span class="n">col</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'--col'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Number of sample per column'</span>
    <span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Custom command to view training dataset</span>

<span class="sd">    \b</span>
<span class="sd">    Invoke this command with:</span>
<span class="sd">    mltk custom siamese_contrastive visualize</span>
<span class="sd">    mltk custom siamese_contrastive visualize --predict</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">predict</span><span class="p">:</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">'validation'</span><span class="p">)</span>
        <span class="c1"># Load the trained .h5 model</span>
        <span class="n">keras_model</span> <span class="o">=</span> <span class="n">load_tflite_or_keras_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">'h5'</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">visualize</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">to_show</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">num_col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">'training'</span><span class="p">)</span>
        <span class="n">visualize</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">my_model</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">to_show</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">num_col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

    <span class="n">my_model</span><span class="o">.</span><span class="n">unload_dataset</span><span class="p">()</span>




<span class="c1">##########################################################################################</span>
<span class="c1"># The following allows for running this model training script directly, e.g.:</span>
<span class="c1"># python siamese_contrastive.py</span>
<span class="c1">#</span>
<span class="c1"># Note that this has the same functionality as:</span>
<span class="c1"># mltk train siamese_contrastive</span>
<span class="c1">#</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mltk</span> <span class="kn">import</span> <span class="n">cli</span>

    <span class="c1"># Setup the CLI logger</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># If this is true then this will do a "dry run" of the model testing</span>
    <span class="c1"># If this is false, then the model will be fully trained</span>
    <span class="n">test_mode_enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Train the model</span>
    <span class="c1"># This does the same as issuing the command: mltk train siamese_contrastive-test --clean</span>
    <span class="n">train_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_results</span><span class="p">)</span>

    <span class="c1"># Evaluate the model against the quantized .h5 (i.e. float32) model</span>
    <span class="c1"># This does the same as issuing the command: mltk evaluate siamese_contrastive-test</span>
    <span class="n">tflite_eval_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tflite_eval_results</span><span class="p">)</span>

    <span class="c1"># Profile the model in the simulator</span>
    <span class="c1"># This does the same as issuing the command: mltk profile siamese_contrastive-test</span>
    <span class="n">profiling_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">profile_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">profiling_results</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </article>
        </div>
      </div>
      <a href="#" class="go-top"><i class="md-icon">arrow_upward</i>Back to Top</a>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="autoencoder_example.html" title="autoencoder_example"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> autoencoder_example </span>
              </div>
            </a>
          
          
            <a href="../siliconlabs/index.html" title="Silicon Labâ€™s Models"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Silicon Labâ€™s Models </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2023, Silicon Labs.
              
          </div>
            Last updated on
              Jun 19, 2023.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
        <button id="survey-link" class="feedback-button">Feedback</button>
      </div>
    </div>
  </footer>
  <div class="privacy-banner">
    <div class="privacy-banner-wrapper">
      <p>
        <b>Important:</b> We use cookies only for functional and traffic analytics. <br />
        We DO NOT use cookies for any marketing purposes. By using our site you acknowledge you have read and understood our <a class="privacy-policy" href="https://www.silabs.com/about-us/legal/cookie-policy" target="_blank">Cookie Policy</a>.
      </p>
      <a class="privacy-banner-accept" href="#">Got it</a>
    </div>
</div>
  
<div class="survey-container" id="dlg-survey"> 
    <div class="close" id="dlg-survey-close"><i class="md-icon">close</i></div>
    <div class="msg">Please click the <b>submit</b> button at the end even if you do not answer all of the questions</div>
    <iframe id="iframe-survey" style="width: 100%; height: 100%;"></iframe>
</div>
  
  <script src="../../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>