
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="title" content="Machine Learning Toolkit">
<meta name="description" content="A Python package with command-line utilities and scripts to aid the development of machine learning models for Silicon Lab's embedded platforms">
<meta name="keywords" content="machine learning, machine-learning, machinelearning, ml, ai, iot, Internet of things, aiot, tinyml, tensorflow, tensorflow-lite, tensorflow-lite-micro, keras-tensorflow, keras, tflite, embedded, embedded-systems, mcu, Microcontrollers, hardware, python, c++, cmake, keras, numpy, silabs, silicon labs">
<meta name="robots" content="index, follow">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="language" content="English">
<meta name="author" content="Silicon Labs">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HZ5MW943WF"></script>
<script>
    window.gTrackingId = 'G-HZ5MW943WF';
</script>
<meta name="google-site-verification" content="dsSsmnE2twOnfSAQk5zBBTrjMArsTJj809Bp-8mVlIw" />
  
  
    <title>keyword_spotting_on_off_v2 &#8212; MLTK 0.20.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/custom.js"></script>
    <script src="../../../../_static/js/apitoc.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="keyword_spotting_on_off_v3" href="keyword_spotting_on_off_v3.html" />
    <link rel="prev" title="keyword_spotting_on_off" href="keyword_spotting_on_off.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=red data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#docs/python_api/models/siliconlabs/keyword_spotting_on_off_v2" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../../index.html" title="MLTK 0.20.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../../../../_static/logo.png"
                   alt="MLTK 0.20.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Machine Learning Toolkit</span>
          <span class="md-header-nav__topic"> keyword_spotting_on_off_v2 </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="https://docs.silabs.com/gecko-platform/latest/machine-learning/tensorflow/overview" class="md-tabs__link">Gecko SDK Documentation</a></li>
            
            <li class="md-tabs__item"><a href="https://github.com/tensorflow/tflite-micro" class="md-tabs__link">Tensorflow-Lite Micro Repository</a></li>
            
            <li class="md-tabs__item"><a href="https://www.tensorflow.org/learn" class="md-tabs__link">Tensorflow Documentation</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Reference Models</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Silicon Lab’s Models</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../../index.html" title="MLTK 0.20.0 documentation" class="md-nav__button md-logo">
      
        <img src="../../../../_static/logo.png" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../../index.html"
       title="MLTK 0.20.0 documentation">Machine Learning Toolkit</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Basics</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../overview.html" class="md-nav__link">Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../why_mltk.html" class="md-nav__link">Why MLTK?</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../installation.html" class="md-nav__link">Installation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../command_line/index.html" class="md-nav__link">Command-Line</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/index.html" class="md-nav__link">Modeling Guides</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Usage</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../tutorials.html" class="md-nav__link">Tutorials</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../examples.html" class="md-nav__link">API Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../index.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../index.html" class="md-nav__link">Reference Models</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../examples/index.html" class="md-nav__link">Example Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">Silicon Lab’s Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tinyml/index.html" class="md-nav__link">TinyML Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tflite_micro/index.html" class="md-nav__link">Tensorflow-Lite Micro Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../common_models.html" class="md-nav__link">Common Model Architectures</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../datasets/index.html" class="md-nav__link">Reference Datasets</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/index.html" class="md-nav__link">C++ Development</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/examples/index.html" class="md-nav__link">C++ Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Audio Related</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/keyword_spotting_overview.html" class="md-nav__link">Keyword Spotting Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_feature_generator.html" class="md-nav__link">Audio Feature Generator</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_utilities.html" class="md-nav__link">Audio Utilities</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Other Information</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../faq/index.html" class="md-nav__link">Frequently Asked Questions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/quick_reference.html" class="md-nav__link">Quick Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/supported_hardware.html" class="md-nav__link">Supported Hardware</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/notebook_examples_guide.html" class="md-nav__link">Notebook Examples Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/settings_file.html" class="md-nav__link">Settings File</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/environment_variables.html" class="md-nav__link">Environment Variables</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="" id="localtoc">
        <li class="md-nav__item"><a href="#docs-python-api-models-siliconlabs-keyword-spotting-on-off-v2--page-root" class="md-nav__link">keyword_spotting_on_off_v2</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#training-the-model" class="md-nav__link">Training the Model</a>
        </li>
        <li class="md-nav__item"><a href="#changes-from-v1" class="md-nav__link">Changes from v1</a>
        </li>
        <li class="md-nav__item"><a href="#dataset" class="md-nav__link">Dataset</a>
        </li>
        <li class="md-nav__item"><a href="#preprocessing" class="md-nav__link">Preprocessing</a>
        </li>
        <li class="md-nav__item"><a href="#commands" class="md-nav__link">Commands</a>
        </li>
        <li class="md-nav__item"><a href="#model-summary" class="md-nav__link">Model Summary</a>
        </li>
        <li class="md-nav__item"><a href="#model-profiling-report" class="md-nav__link">Model Profiling Report</a>
        </li>
        <li class="md-nav__item"><a href="#model-diagram" class="md-nav__link">Model Diagram</a>
        </li>
        <li class="md-nav__item"><a href="#model-specification" class="md-nav__link">Model Specification</a>
        </li></ul>
            </nav>
        </li>
      <script type="text/javascript" src=../../../../_static/js/apitoc.js></script>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">

          
          <div class="breadcrumbs md-typeset">
            <ul class="breadcrumb">
              <li></li>
              <li><a href="../../../../index.html"><i class="md-icon">home</i></a></li>
                <li><a href="../index.html" >Reference Models</a></li>
                <li><a href="index.html" accesskey="U">Silicon Lab’s Models</a></li>

              <li class="activate"><a>keyword_spotting_on_off_v2</a></li>
            </ul>
          </div>
          

          <article class="md-content__inner md-typeset" role="main">
            
  <span class="target" id="module-mltk.models.siliconlabs.keyword_spotting_on_off_v2"></span><section id="keyword-spotting-on-off-v2">
<h1 id="docs-python-api-models-siliconlabs-keyword-spotting-on-off-v2--page-root">keyword_spotting_on_off_v2<a class="headerlink" href="#docs-python-api-models-siliconlabs-keyword-spotting-on-off-v2--page-root" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Source code: <a class="reference external" href="https://github.com/siliconlabs/mltk/blob/master/mltk/models/siliconlabs/keyword_spotting_on_off_v2.py">keyword_spotting_on_off_v2.py</a></p></li>
<li><p>Pre-trained model: <a class="reference external" href="https://github.com/siliconlabs/mltk/blob/master/mltk/models/siliconlabs/keyword_spotting_on_off_v2.mltk.zip">keyword_spotting_on_off_v2.mltk.zip</a></p></li>
</ul>
<p>This model is a CNN classifier to detect the keywords:</p>
<ul class="simple">
<li><p>on</p></li>
<li><p>off</p></li>
</ul>
<p>This model specification script is designed to work with the
<a class="reference external" href="../../../../mltk/tutorials/keyword_spotting_on_off.html">Keyword Spotting On/Off</a> tutorial.</p>
<section id="training-the-model">
<h2 id="training-the-model">Training the Model<a class="headerlink" href="#training-the-model" title="Permalink to this heading">¶</a></h2>
<p>This model uses <a class="reference external" href="https://keras.io/examples/vision/knowledge_distillation/">Knowledge Distallation</a>.</p>
<p>The basic idea behind knowledge distallation is:</p>
<ol class="arabic simple">
<li><p>Train a large (aka “teacher”) model that gets good accuracy</p></li>
<li><p>Train smaller (aka “student”) model with the guidance of the “teacher” model</p></li>
</ol>
<p>In this way, the “student” model can more efficiently learn the important features of the dataset
and get similar accuracy to the much larger “teacher” model.</p>
<p>To train the teacher model, define the environment variable <code class="docutils literal notranslate"><span class="pre">TRAIN_TEACHER=1</span></code> then train:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">TRAIN_TEACHER</span><span class="o">=</span><span class="m">1</span>
mltk<span class="w"> </span>train<span class="w"> </span>keyword_spotting_on_off_v2
</pre></div>
</div>
<p>This will generate the file: <code class="docutils literal notranslate"><span class="pre">keyword_spotting_on_off_v2.teacher.h5</span></code> in the same directory as the current file.
This is the teacher model in the Keras <code class="docutils literal notranslate"><span class="pre">HDF5</span></code> format.</p>
<p>Once the teacher is trained, the “student” model (the model that is programmed to the embedded device) is
trained by defining the environment variable: <code class="docutils literal notranslate"><span class="pre">TRAIN_TEACHER=0</span></code>, e.g.:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">TRAIN_TEACHER</span><span class="o">=</span><span class="m">0</span>
mltk<span class="w"> </span>train<span class="w"> </span>keyword_spotting_on_off_v2
</pre></div>
</div>
<p>When training the student model, the <code class="docutils literal notranslate"><span class="pre">keyword_spotting_on_off_v2.teacher.h5</span></code> will be loaded and used during model training.</p>
</section>
<section id="changes-from-v1">
<h2 id="changes-from-v1">Changes from v1<a class="headerlink" href="#changes-from-v1" title="Permalink to this heading">¶</a></h2>
<p>The following changes have been made from the original <a class="reference external" href="../../../../docs/python_api/models/siliconlabs/keyword_spotting_on_off.html">keyword_spotting_on_off</a> model:</p>
<ol class="arabic simple">
<li><p>Cleaned the <a class="reference internal" href="../../datasets/audio/speech_commands_v2.html#module-mltk.datasets.audio.speech_commands.speech_commands_v2" title="mltk.datasets.audio.speech_commands.speech_commands_v2"><code class="xref py py-class docutils literal notranslate"><span class="pre">mltk.datasets.audio.speech_commands.speech_commands_v2</span></code></a> dataset by removing invalid samples</p>
<ul class="simple">
<li><p>This gives the most improvement</p></li>
</ul>
</li>
<li><p>Knowledge distillation</p>
<ul class="simple">
<li><p>Phase 1: Train a large model that gets good accuracy</p></li>
<li><p>Phase 2: Train smaller with the guidance of the larger model</p></li>
<li><p>The smaller leverages the knowledge of the larger</p></li>
<li><p>More details at <a class="reference external" href="https://keras.io/examples/vision/knowledge_distillation/">Knowledge Distallation</a></p></li>
</ul>
</li>
<li><p>Increased the size of the model</p>
<ul class="simple">
<li><p>Previously, a smaller model that executed very quickly was used, and several inferences were averaged</p></li>
<li><p>Now, a larger model that executes in 90ms and no averaging</p></li>
<li><p>This helps to make the keyword detection more responsive</p></li>
</ul>
</li>
<li><p>Increased the size of the “on” and “off” classes</p>
<ul class="simple">
<li><p>~9k synthetic samples for each class were generated using the <a class="reference external" href="https://codelabs.developers.google.com/codelabs/cloud-text-speech-python3#0">Google Cloud Text-to-Speech Feature</a></p></li>
<li><p>These samples were added to the Google <a class="reference external" href="../../../../docs/python_api/datasets/index.html#google-speech-commands-v2">speech_commands</a> dataset</p></li>
</ul>
</li>
<li><p>Increased the size of the “unknown” class</p>
<ul class="simple">
<li><p>Synthetic audio samples such as “ah”, “onning”, etc. were generated an added to the “unknown” dataset samples</p></li>
</ul>
</li>
<li><p>Added cropped “known” samples to the “unknown” class</p>
<ul class="simple">
<li><p>This way the model only triggers on fully buffered keywords, not partial words as they’re streaming in</p></li>
</ul>
</li>
<li><p>Added better background noise</p>
<ul class="simple">
<li><p>Sounds of crowds, conferences, etc.</p></li>
</ul>
</li>
<li><p>Added <a class="reference external" href="../../../../docs/other/supported_hardware.html#brd2601">BRD2601</a> background noise to all samples</p>
<ul class="simple">
<li><p>The dev board microphone has a low frequency “hum”; this was recorded and added to all the training samples so they “look” closer to what would be seen at runtime</p></li>
</ul>
</li>
<li><p>Re-enabled the Microfrontend Noise Reduction block</p>
<ul class="simple">
<li><p>This was found to greatly help with generating clean spectrograms at runtime</p></li>
<li><p>During training, each sample is padded with an extra 1s of background noise so that the noise reduction block properly “warms up” before the actual keyword streams in. The padding is then removed in the resulting spectrogram</p></li>
</ul>
</li>
</ol>
</section>
<section id="dataset">
<h2 id="dataset">Dataset<a class="headerlink" href="#dataset" title="Permalink to this heading">¶</a></h2>
<p>This uses the <a class="reference internal" href="../../datasets/audio/speech_commands_v2.html#module-mltk.datasets.audio.speech_commands.speech_commands_v2" title="mltk.datasets.audio.speech_commands.speech_commands_v2"><code class="xref py py-class docutils literal notranslate"><span class="pre">mltk.datasets.audio.speech_commands.speech_commands_v2</span></code></a> dataset provided by Google.
Plus an additional synthetic audio samples generated using the Google Cloud
and background noise for <a class="reference external" href="https://mixkit.co">https://mixkit.co</a></p>
</section>
<section id="preprocessing">
<h2 id="preprocessing">Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading">¶</a></h2>
<p>This uses the <a class="reference internal" href="../../data_preprocessing/audio_feature_generator.html#mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator" title="mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator"><code class="xref py py-class docutils literal notranslate"><span class="pre">mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator</span></code></a> with the
<a class="reference internal" href="../../data_preprocessing/audio_feature_generator.html#mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator" title="mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator"><code class="xref py py-class docutils literal notranslate"><span class="pre">mltk.core.preprocess.audio.audio_feature_generator.AudioFeatureGenerator</span></code></a> settings:</p>
<ul class="simple">
<li><p>sample_rate: 16kHz</p></li>
<li><p>sample_length: 1000ms</p></li>
<li><p>window size: 20ms</p></li>
<li><p>window step: 10ms</p></li>
<li><p>n_channels: 68</p></li>
</ul>
</section>
<section id="commands">
<h2 id="commands">Commands<a class="headerlink" href="#commands" title="Permalink to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a "dry run" test training of the "teacher" model</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TRAIN_TEACHER</span><span class="o">=</span><span class="m">1</span>
mltk<span class="w"> </span>train<span class="w"> </span>keyword_spotting_on_off_v2-test

<span class="c1"># Train the "teacher" model</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TRAIN_TEACHER</span><span class="o">=</span><span class="m">1</span>
mltk<span class="w"> </span>train<span class="w"> </span>keyword_spotting_on_off_v2

<span class="c1"># Train the "student" model</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TRAIN_TEACHER</span><span class="o">=</span><span class="m">0</span>
mltk<span class="w"> </span>train<span class="w"> </span>keyword_spotting_on_off_v2

<span class="c1"># Evaluate the trained model .tflite model</span>
mltk<span class="w"> </span>evaluate<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--tflite

<span class="c1"># Profile the model in the MVP hardware accelerator simulator</span>
mltk<span class="w"> </span>profile<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--accelerator<span class="w"> </span>MVP

<span class="c1"># Profile the model on a physical development board</span>
mltk<span class="w"> </span>profile<span class="w"> </span>keyword_spotting_on_off_v2<span class="w">  </span>--accelerator<span class="w"> </span>MVP<span class="w"> </span>--device

<span class="c1"># Run the model in the audio classifier on the local PC</span>
mltk<span class="w"> </span>classify_audio<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--verbose

<span class="c1"># Run the model in the audio classifier on the physical device</span>
mltk<span class="w"> </span>classify_audio<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--device<span class="w"> </span>--verbose
</pre></div>
</div>
</section>
<section id="model-summary">
<h2 id="model-summary">Model Summary<a class="headerlink" href="#model-summary" title="Permalink to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mltk<span class="w"> </span>summarize<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--tflite

+-------+-----------------+-----------------+-----------------+-----------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Index<span class="w"> </span><span class="p">|</span><span class="w"> </span>OpCode<span class="w">          </span><span class="p">|</span><span class="w"> </span>Input<span class="o">(</span>s<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span>Output<span class="o">(</span>s<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span>Config<span class="w">                                              </span><span class="p">|</span>
+-------+-----------------+-----------------+-----------------+-----------------------------------------------------+
<span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>99x68x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>99x68x10<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>3x3x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">    </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span>99x68x10<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>49x34x10<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>49x34x10<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>49x34x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>3x3x10<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span>49x34x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>24x17x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>24x17x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>24x17x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>3x3x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">5</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span>24x17x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>12x8x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">6</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>12x8x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>12x8x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>3x3x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">40</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">7</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span>12x8x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>6x4x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">8</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span>6x4x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>6x4x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span>3x3x40<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">      </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">9</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span>6x4x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>1x4x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:1x6<span class="w"> </span>filter:1x6<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>reshape<span class="w">         </span><span class="p">|</span><span class="w"> </span>1x4x20<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>none<span class="w">                                           </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">11</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span>Activation:None<span class="w">                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">80</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                     </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">12</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>softmax<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>softmaxoptions<span class="w">                                 </span><span class="p">|</span>
+-------+-----------------+-----------------+-----------------+-----------------------------------------------------+
Total<span class="w"> </span>MACs:<span class="w"> </span><span class="m">8</span>.098<span class="w"> </span>M
Total<span class="w"> </span>OPs:<span class="w"> </span><span class="m">16</span>.436<span class="w"> </span>M
Name:<span class="w"> </span>keyword_spotting_on_off_v2
Version:<span class="w"> </span><span class="m">2</span>
Description:<span class="w"> </span>Keyword<span class="w"> </span>spotting<span class="w"> </span>classifier<span class="w"> </span>to<span class="w"> </span>detect:<span class="w"> </span><span class="s2">"on"</span><span class="w"> </span>and<span class="w"> </span><span class="s2">"off"</span>,<span class="w"> </span>version<span class="w"> </span><span class="m">2</span>
Classes:<span class="w"> </span>on,<span class="w"> </span>off,<span class="w"> </span>_unknown_
Runtime<span class="w"> </span>memory<span class="w"> </span>size<span class="w"> </span><span class="o">(</span>RAM<span class="o">)</span>:<span class="w"> </span><span class="m">91</span>.272<span class="w"> </span>k
hash:<span class="w"> </span>d701916160b1c6e41f145a166428b7c3
date:<span class="w"> </span><span class="m">2022</span>-11-04T23:05:49.214Z
fe.sample_rate_hz:<span class="w"> </span><span class="m">16000</span>
fe.fft_length:<span class="w"> </span><span class="m">512</span>
fe.sample_length_ms:<span class="w"> </span><span class="m">1000</span>
fe.window_size_ms:<span class="w"> </span><span class="m">20</span>
fe.window_step_ms:<span class="w"> </span><span class="m">10</span>
fe.filterbank_n_channels:<span class="w"> </span><span class="m">68</span>
fe.filterbank_upper_band_limit:<span class="w"> </span><span class="m">8000</span>.0
fe.filterbank_lower_band_limit:<span class="w"> </span><span class="m">125</span>.0
fe.noise_reduction_enable:<span class="w"> </span>True
fe.noise_reduction_smoothing_bits:<span class="w"> </span><span class="m">10</span>
fe.noise_reduction_even_smoothing:<span class="w"> </span><span class="m">0</span>.02500000037252903
fe.noise_reduction_odd_smoothing:<span class="w"> </span><span class="m">0</span>.05999999865889549
fe.noise_reduction_min_signal_remaining:<span class="w"> </span><span class="m">0</span>.029999999329447746
fe.pcan_enable:<span class="w"> </span>False
fe.pcan_strength:<span class="w"> </span><span class="m">0</span>.949999988079071
fe.pcan_offset:<span class="w"> </span><span class="m">80</span>.0
fe.pcan_gain_bits:<span class="w"> </span><span class="m">21</span>
fe.log_scale_enable:<span class="w"> </span>True
fe.log_scale_shift:<span class="w"> </span><span class="m">6</span>
fe.activity_detection_enable:<span class="w"> </span>False
fe.activity_detection_alpha_a:<span class="w"> </span><span class="m">0</span>.5
fe.activity_detection_alpha_b:<span class="w"> </span><span class="m">0</span>.800000011920929
fe.activity_detection_arm_threshold:<span class="w"> </span><span class="m">0</span>.75
fe.activity_detection_trip_threshold:<span class="w"> </span><span class="m">0</span>.800000011920929
fe.dc_notch_filter_enable:<span class="w"> </span>True
fe.dc_notch_filter_coefficient:<span class="w"> </span><span class="m">0</span>.949999988079071
fe.quantize_dynamic_scale_enable:<span class="w"> </span>True
fe.quantize_dynamic_scale_range_db:<span class="w"> </span><span class="m">40</span>.0
latency_ms:<span class="w"> </span><span class="m">200</span>
minimum_count:<span class="w"> </span><span class="m">2</span>
average_window_duration_ms:<span class="w"> </span><span class="m">440</span>
detection_threshold:<span class="w"> </span><span class="m">178</span>
suppression_ms:<span class="w"> </span><span class="m">900</span>
volume_gain:<span class="w"> </span><span class="m">0</span>
verbose_model_output_logs:<span class="w"> </span>False
.tflite<span class="w"> </span>file<span class="w"> </span>size:<span class="w"> </span><span class="m">45</span>.4kB
</pre></div>
</div>
</section>
<section id="model-profiling-report">
<h2 id="model-profiling-report">Model Profiling Report<a class="headerlink" href="#model-profiling-report" title="Permalink to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Profile on physical EFR32xG24 using MVP accelerator</span>
mltk<span class="w"> </span>profile<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--device<span class="w"> </span>--accelerator<span class="w"> </span>MVP

<span class="w"> </span>Profiling<span class="w"> </span>Summary
<span class="w"> </span>Name:<span class="w"> </span>keyword_spotting_on_off_v2
<span class="w"> </span>Accelerator:<span class="w"> </span>MVP
<span class="w"> </span>Input<span class="w"> </span>Shape:<span class="w"> </span>1x99x68x1
<span class="w"> </span>Input<span class="w"> </span>Data<span class="w"> </span>Type:<span class="w"> </span>int8
<span class="w"> </span>Output<span class="w"> </span>Shape:<span class="w"> </span>1x3
<span class="w"> </span>Output<span class="w"> </span>Data<span class="w"> </span>Type:<span class="w"> </span>int8
<span class="w"> </span>Flash,<span class="w"> </span>Model<span class="w"> </span>File<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>:<span class="w"> </span><span class="m">45</span>.4k
<span class="w"> </span>RAM,<span class="w"> </span>Runtime<span class="w"> </span>Memory<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>:<span class="w"> </span><span class="m">91</span>.2k
<span class="w"> </span>Operation<span class="w"> </span>Count:<span class="w"> </span><span class="m">16</span>.7M
<span class="w"> </span>Multiply-Accumulate<span class="w"> </span>Count:<span class="w"> </span><span class="m">8</span>.1M
<span class="w"> </span>Layer<span class="w"> </span>Count:<span class="w"> </span><span class="m">13</span>
<span class="w"> </span>Unsupported<span class="w"> </span>Layer<span class="w"> </span>Count:<span class="w"> </span><span class="m">0</span>
<span class="w"> </span>Accelerator<span class="w"> </span>Cycle<span class="w"> </span>Count:<span class="w"> </span><span class="m">6</span>.5M
<span class="w"> </span>CPU<span class="w"> </span>Cycle<span class="w"> </span>Count:<span class="w"> </span><span class="m">278</span>.1k
<span class="w"> </span>CPU<span class="w"> </span>Utilization<span class="w"> </span><span class="o">(</span>%<span class="o">)</span>:<span class="w"> </span><span class="m">4</span>.3
<span class="w"> </span>Clock<span class="w"> </span>Rate<span class="w"> </span><span class="o">(</span>hz<span class="o">)</span>:<span class="w"> </span><span class="m">78</span>.0M
<span class="w"> </span>Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span>:<span class="w"> </span><span class="m">83</span>.6m
<span class="w"> </span>Ops/s:<span class="w"> </span><span class="m">199</span>.2M
<span class="w"> </span>MACs/s:<span class="w"> </span><span class="m">96</span>.6M
<span class="w"> </span>Inference/s:<span class="w"> </span><span class="m">12</span>.0

<span class="w"> </span>Model<span class="w"> </span>Layers
<span class="w"> </span>+-------+-----------------+--------+--------+------------+------------+----------+-------------------------+--------------+-----------------------------------------------------+
<span class="w"> </span><span class="p">|</span><span class="w"> </span>Index<span class="w"> </span><span class="p">|</span><span class="w"> </span>OpCode<span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="c1"># Ops  | # MACs | Acc Cycles | CPU Cycles | Time (s) | Input Shape             | Output Shape | Options                                             |</span>
<span class="w"> </span>+-------+-----------------+--------+--------+------------+------------+----------+-------------------------+--------------+-----------------------------------------------------+
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.4M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">605</span>.9k<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">959</span>.0k<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.4k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">12</span>.3m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x99x68x1,10x3x3x1,10<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x99x68x10<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">66</span>.6k<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">50</span>.0k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">10</span>.2k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">720</span>.0u<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x99x68x10<span class="w">              </span><span class="p">|</span><span class="w"> </span>1x49x34x10<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">6</span>.1M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.0M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.3M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.1k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">29</span>.1m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x49x34x10,20x3x3x10,20<span class="w"> </span><span class="p">|</span><span class="w"> </span>1x49x34x20<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">32</span>.6k<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">24</span>.6k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">19</span>.0k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">420</span>.0u<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x49x34x20<span class="w">              </span><span class="p">|</span><span class="w"> </span>1x24x17x20<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">5</span>.9M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.9M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.1M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.2k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">26</span>.8m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x24x17x20,40x3x3x20,40<span class="w"> </span><span class="p">|</span><span class="w"> </span>1x24x17x40<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">5</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">15</span>.4k<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">11</span>.8k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">36</span>.5k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">450</span>.0u<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x24x17x40<span class="w">              </span><span class="p">|</span><span class="w"> </span>1x12x8x40<span class="w">    </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">6</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.8M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.4M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">912</span>.6k<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.2k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">11</span>.6m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x12x8x40,40x3x3x40,40<span class="w">  </span><span class="p">|</span><span class="w"> </span>1x12x8x40<span class="w">    </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">7</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.8k<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.2k<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">36</span>.5k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">480</span>.0u<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x12x8x40<span class="w">               </span><span class="p">|</span><span class="w"> </span>1x6x4x40<span class="w">     </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">8</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">347</span>.0k<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">172</span>.8k<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">99</span>.5k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.2k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.4m<span class="w">     </span><span class="p">|</span><span class="w"> </span>1x6x4x40,20x3x3x40,20<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x6x4x20<span class="w">     </span><span class="p">|</span><span class="w"> </span>Padding:Same<span class="w"> </span>stride:1x1<span class="w"> </span>activation:Relu<span class="w">             </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">9</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>max_pool_2d<span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">480</span>.0<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">460</span>.0<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">18</span>.7k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">240</span>.0u<span class="w">   </span><span class="p">|</span><span class="w"> </span>1x6x4x20<span class="w">                </span><span class="p">|</span><span class="w"> </span>1x1x4x20<span class="w">     </span><span class="p">|</span><span class="w"> </span>Padding:Valid<span class="w"> </span>stride:1x6<span class="w"> </span>filter:1x6<span class="w"> </span>activation:None<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">10</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>reshape<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">860</span>.0<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.0u<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x1x4x20,2<span class="w">              </span><span class="p">|</span><span class="w"> </span>1x80<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>none<span class="w">                                           </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">11</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">483</span>.0<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">240</span>.0<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">396</span>.0<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.2k<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.0u<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x80,3x80,3<span class="w">             </span><span class="p">|</span><span class="w"> </span>1x3<span class="w">          </span><span class="p">|</span><span class="w"> </span>Activation:None<span class="w">                                     </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">12</span><span class="w">    </span><span class="p">|</span><span class="w"> </span>softmax<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="m">15</span>.0<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.0k<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.0u<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x3<span class="w">                     </span><span class="p">|</span><span class="w"> </span>1x3<span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>softmaxoptions<span class="w">                                 </span><span class="p">|</span>
<span class="w"> </span>+-------+-----------------+--------+--------+------------+------------+----------+-------------------------+--------------+-----------------------------------------------------+
</pre></div>
</div>
</section>
<section id="model-diagram">
<h2 id="model-diagram">Model Diagram<a class="headerlink" href="#model-diagram" title="Permalink to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mltk<span class="w"> </span>view<span class="w"> </span>keyword_spotting_on_off_v2<span class="w"> </span>--tflite
</pre></div>
</div>
<div class="model-diagram">
<a href="../../../../_images/models/keyword_spotting_on_off_v2.tflite.png" target="_blank">
<img src="../../../../_images/models/keyword_spotting_on_off_v2.tflite.png"/>
<p>Click to enlarge</p>
</a>
</div></section>
<section id="model-specification">
<h2 id="model-specification">Model Specification<a class="headerlink" href="#model-specification" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the Tensorflow packages</span>
<span class="c1"># required to build the model layout</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">mltk.core</span> <span class="k">as</span> <span class="nn">mltk_core</span>

<span class="c1"># Import the Google speech_commands dataset package</span>
<span class="c1"># This manages downloading and extracting the dataset</span>
<span class="kn">from</span> <span class="nn">mltk.datasets.audio.speech_commands</span> <span class="kn">import</span> <span class="n">speech_commands_v2</span>

<span class="c1"># Import the AudioFeatureGeneratorSettings which we'll configure</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.audio.audio_feature_generator</span> <span class="kn">import</span> <span class="n">AudioFeatureGeneratorSettings</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.utils</span> <span class="kn">import</span> <span class="n">tf_dataset</span> <span class="k">as</span> <span class="n">tf_dataset_utils</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.utils</span> <span class="kn">import</span> <span class="n">audio</span> <span class="k">as</span> <span class="n">audio_utils</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.utils</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">image_utils</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.utils</span> <span class="kn">import</span> <span class="n">split_file_list</span>
<span class="kn">from</span> <span class="nn">mltk.utils.python</span> <span class="kn">import</span> <span class="n">install_pip_package</span>
<span class="kn">from</span> <span class="nn">mltk.utils.archive_downloader</span> <span class="kn">import</span> <span class="n">download_verify_extract</span><span class="p">,</span> <span class="n">download_url</span>
<span class="kn">from</span> <span class="nn">mltk.core.keras.models</span> <span class="kn">import</span> <span class="n">KnowledgeDistillationModel</span>




<span class="c1">##########################################################################</span>
<span class="c1"># Instantiate the MltkModel instance</span>
<span class="c1">#</span>

<span class="c1"># @mltk_model</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">MltkModel</span><span class="p">,</span>    <span class="c1"># We must inherit the MltkModel class</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">TrainMixin</span><span class="p">,</span>   <span class="c1"># We also inherit the TrainMixin since we want to train this model</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">DatasetMixin</span><span class="p">,</span> <span class="c1"># We also need the DatasetMixin mixin to provide the relevant dataset properties</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">EvaluateClassifierMixin</span><span class="p">,</span>  <span class="c1"># While not required, also inherit EvaluateClassifierMixin to help will generating evaluation stats for our classification model</span>
    <span class="n">mltk_core</span><span class="o">.</span><span class="n">SshMixin</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">pass</span>
<span class="n">my_model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>


<span class="c1">#################################################</span>
<span class="c1"># General Settings</span>

<span class="c1"># For better tracking, the version should be incremented any time a non-trivial change is made</span>
<span class="c1"># NOTE: The version is optional and not used directly used by the MLTK</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># Provide a brief description about what this model models</span>
<span class="c1"># This description goes in the "description" field of the .tflite model file</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">'Keyword spotting classifier to detect: "on" and "off", version 2'</span>

<span class="c1">#################################################</span>
<span class="c1"># Training Basic Settings</span>

<span class="c1"># This specifies the number of times we run the training</span>
<span class="c1"># samples through the model to update the model weights.</span>
<span class="c1"># Typically, a larger value leads to better accuracy at the expense of training time.</span>
<span class="c1"># Otherwise set this to a specific value (typically 40-200)</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">75</span>
<span class="c1"># Specify how many samples to pass through the model</span>
<span class="c1"># before updating the training gradients.</span>
<span class="c1"># Typical values are 10-64</span>
<span class="c1"># NOTE: Larger values require more memory and may not fit on your GPU</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>


<span class="c1">##########################################################################</span>
<span class="c1"># Define the model architecture</span>
<span class="c1">#</span>

<span class="k">def</span> <span class="nf">my_teacher_model_builder</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Build the "Teacher" Keras model</span>

<span class="sd">    This is used when the environment variable: TRAIN_TEACHER=1</span>

<span class="sd">    This is called by the MLTK just before "teacher" training starts.</span>
<span class="sd">    See https://keras.io/examples/vision/knowledge_distillation/ for more details.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        my_model: The MltkModel instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        Compiled Keras model instance</span>
<span class="sd">    """</span>

    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="mi">48</span>

    <span class="n">keras_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span><span class="s1">'-teacher'</span><span class="p">)</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="n">keras_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'softmax'</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">'categorical_crossentropy'</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
        <span class="n">metrics</span><span class="o">=</span> <span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">keras_model</span>


<span class="k">def</span> <span class="nf">my_teacher_model_saver</span><span class="p">(</span>
    <span class="n">mltk_model</span><span class="p">:</span><span class="n">mltk_core</span><span class="o">.</span><span class="n">MltkModel</span><span class="p">,</span>
    <span class="n">keras_model</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Save the teacher model</span>

<span class="sd">    This is called just after model training completes.</span>
<span class="sd">    This copies the keyword_spotting_on_off_v2.teacher.h5</span>
<span class="sd">    model file to same directory as the current python script.</span>

<span class="sd">    This is used when the environment variable: TRAIN_TEACHER=1</span>

<span class="sd">    """</span>
    <span class="n">teacher_h5_path</span> <span class="o">=</span> <span class="n">get_teacher_h5_path</span><span class="p">(</span><span class="n">check_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Saving </span><span class="si">{</span><span class="n">teacher_h5_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">'tf'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">keras_model</span>



<span class="k">def</span> <span class="nf">my_student_model_builder</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Build the "Student" Keras model</span>

<span class="sd">    This is called by the MLTK just before training starts.</span>
<span class="sd">    This is used when the environment variable: TRAIN_TEACHER=0</span>
<span class="sd">    See https://keras.io/examples/vision/knowledge_distillation/ for more details.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        my_model: The MltkModel instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        Compiled Keras model instance</span>
<span class="sd">    """</span>

    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_shape</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">keras_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">'-student'</span><span class="p">)</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'same'</span><span class="p">,))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">))</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="n">keras_model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">'softmax'</span><span class="p">))</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="s1">'categorical_crossentropy'</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span> <span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Load the previously saved "teacher" keras model</span>
    <span class="n">teacher_h5_path</span> <span class="o">=</span> <span class="n">get_teacher_h5_path</span><span class="p">(</span><span class="n">try_archive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">teacher_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">,</span> <span class="nb">compile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">distiller</span> <span class="o">=</span> <span class="n">KnowledgeDistillationModel</span><span class="p">(</span><span class="n">student</span><span class="o">=</span><span class="n">keras_model</span><span class="p">,</span> <span class="n">teacher</span><span class="o">=</span><span class="n">teacher_model</span><span class="p">)</span>
    <span class="n">distiller</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">'accuracy'</span><span class="p">],</span>
        <span class="n">student_loss_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">CategoricalCrossentropy</span><span class="p">(),</span>
        <span class="n">distillation_loss_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">KLDivergence</span><span class="p">(),</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">distiller</span>


<span class="k">def</span> <span class="nf">my_student_model_saver</span><span class="p">(</span>
    <span class="n">mltk_model</span><span class="p">:</span><span class="n">mltk_core</span><span class="o">.</span><span class="n">MltkModel</span><span class="p">,</span>
    <span class="n">keras_model</span><span class="p">:</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Save the student model</span>

<span class="sd">    This is called just after model training completes.</span>
<span class="sd">    This discards the KnowledgeDistillationModel and only saves the student model</span>

<span class="sd">    This is used when the environment variable: TRAIN_TEACHER=0</span>

<span class="sd">    """</span>

    <span class="c1"># Discard the KnowledgeDistillationModel and only save the student model</span>
    <span class="n">student_model</span> <span class="o">=</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">student</span>

    <span class="c1"># Also add the keyword_spotting_on_off_v2.teacher.h5 to the training output directory</span>
    <span class="c1"># This way the teacher model is added to the model archive</span>
    <span class="n">teacher_h5_path</span> <span class="o">=</span> <span class="n">get_teacher_h5_path</span><span class="p">()</span>
    <span class="n">h5_path</span> <span class="o">=</span> <span class="n">mltk_model</span><span class="o">.</span><span class="n">h5_log_dir_path</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">h5_path</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">student_model</span>



<span class="c1">##########################################################################</span>
<span class="c1"># Training callback Settings</span>
<span class="c1">#</span>


<span class="c1"># The MLTK enables the tf.keras.callbacks.ModelCheckpoint by default.</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">'monitor'</span><span class="p">]</span> <span class="o">=</span>  <span class="s1">'val_accuracy'</span>

<span class="c1"># https://keras.io/api/callbacks/reduce_lr_on_plateau/</span>
<span class="c1"># If the test accuracy doesn't improve after 'patience' epochs</span>
<span class="c1"># then decrease the learning rate by 'factor'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">reduce_lr_on_plateau</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
  <span class="n">monitor</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span>
  <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
  <span class="n">patience</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.01</span>
<span class="p">)</span>

<span class="c1"># https://keras.io/api/callbacks/early_stopping/</span>
<span class="c1"># If the validation student loss doesn't improve after 'patience' epochs then stop training</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">early_stopping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
  <span class="n">monitor</span><span class="o">=</span><span class="s1">'val_student_loss'</span><span class="p">,</span>
  <span class="n">mode</span><span class="o">=</span><span class="s1">'min'</span><span class="p">,</span>
  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">patience</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
  <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0001</span>
<span class="p">)</span>

<span class="c1"># https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/TensorBoard</span>
<span class="c1"># my_model.tensorboard = dict(</span>
<span class="c1">#     histogram_freq=0,       # frequency (in epochs) at which to compute activation and weight histograms</span>
<span class="c1">#                             # for the layers of the model. If set to 0, histograms won't be computed.</span>
<span class="c1">#                             # Validation data (or split) must be specified for histogram visualizations.</span>
<span class="c1">#     write_graph=False,       # whether to visualize the graph in TensorBoard. The log file can become quite large when write_graph is set to True.</span>
<span class="c1">#     write_images=False,     # whether to write model weights to visualize as image in TensorBoard.</span>
<span class="c1">#     update_freq="batch",    # 'batch' or 'epoch' or integer. When using 'batch', writes the losses and metrics</span>
<span class="c1">#                             # to TensorBoard after each batch. The same applies for 'epoch'.</span>
<span class="c1">#                             # If using an integer, let's say 1000, the callback will write the metrics and losses</span>
<span class="c1">#                             # to TensorBoard every 1000 batches. Note that writing too frequently to</span>
<span class="c1">#                             # TensorBoard can slow down your training.</span>
<span class="c1">#     profile_batch=(51,51),        # Profile the batch(es) to sample compute characteristics.</span>
<span class="c1">#                             # profile_batch must be a non-negative integer or a tuple of integers.</span>
<span class="c1">#                             # A pair of positive integers signify a range of batches to profile.</span>
<span class="c1">#                             # By default, it will profile the second batch. Set profile_batch=0 to disable profiling.</span>
<span class="c1"># )</span>

<span class="c1"># NOTE: You can also add manually add other KerasCallbacks</span>
<span class="c1"># https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/</span>
<span class="c1"># Any callbacks specified here will override the built-in callbacks</span>
<span class="c1"># (e.g. my_model.reduce_lr_on_plateau, my_model.early_stopping)</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">train_callbacks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">TerminateOnNaN</span><span class="p">()</span>
<span class="p">]</span>



<span class="c1">##########################################################################</span>
<span class="c1"># Specify AudioFeatureGenerator Settings</span>
<span class="c1"># See https://siliconlabs.github.io/mltk/docs/audio/audio_feature_generator.html</span>
<span class="c1">#</span>
<span class="n">frontend_settings</span> <span class="o">=</span> <span class="n">AudioFeatureGeneratorSettings</span><span class="p">()</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span> <span class="o">=</span> <span class="mi">16000</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_length_ms</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">window_size_ms</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">window_step_ms</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">filterbank_n_channels</span> <span class="o">=</span> <span class="mi">68</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">filterbank_upper_band_limit</span> <span class="o">=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span><span class="o">/</span><span class="mi">2</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">filterbank_lower_band_limit</span> <span class="o">=</span> <span class="mf">125.0</span> <span class="c1"># The dev board mic seems to have a lot of noise at lower frequencies</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">noise_reduction_enable</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">noise_reduction_smoothing_bits</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">noise_reduction_even_smoothing</span> <span class="o">=</span>  <span class="mf">0.025</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">noise_reduction_odd_smoothing</span> <span class="o">=</span> <span class="mf">0.06</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">noise_reduction_min_signal_remaining</span> <span class="o">=</span> <span class="mf">0.03</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">pcan_enable</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Disable the PCAN block</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">log_scale_enable</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">log_scale_shift</span> <span class="o">=</span> <span class="mi">6</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">dc_notch_filter_enable</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Enable the DC notch filter</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">dc_notch_filter_coefficient</span> <span class="o">=</span> <span class="mf">0.95</span>

<span class="n">frontend_settings</span><span class="o">.</span><span class="n">quantize_dynamic_scale_enable</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Enable dynamic quantization</span>
<span class="n">frontend_settings</span><span class="o">.</span><span class="n">quantize_dynamic_scale_range_db</span> <span class="o">=</span> <span class="mf">40.0</span>

<span class="c1"># Add the Audio Feature generator settings to the model parameters</span>
<span class="c1"># This way, they are included in the generated .tflite model file</span>
<span class="c1"># See https://siliconlabs.github.io/mltk/docs/guides/model_parameters.html</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">frontend_settings</span><span class="p">)</span>


<span class="c1">##########################################################################</span>
<span class="c1"># Specify the other dataset settings</span>
<span class="c1">#</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">spectrogram_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>

<span class="c1"># Add the direction keywords plus a _unknown_ meta class</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'on'</span><span class="p">,</span> <span class="s1">'off'</span><span class="p">,</span> <span class="s1">'_unknown_'</span><span class="p">]</span>
<span class="n">unknown_class_id</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">'_unknown_'</span><span class="p">)</span>

<span class="c1"># Ensure the class weights are balanced during training</span>
<span class="c1"># https://towardsdatascience.com/why-weight-the-importance-of-training-on-balanced-datasets-f1e54688e7df</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">class_weights</span> <span class="o">=</span> <span class="s1">'balanced'</span>

<span class="n">validation_split</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">unknown_class_multiplier</span> <span class="o">=</span> <span class="mf">2.5</span>

<span class="c1"># Uncomment this to dump the augmented audio samples to the log directory</span>
<span class="c1">#data_dump_dir = my_model.create_log_dir('dataset_dump')</span>



<span class="c1">##########################################################################</span>
<span class="c1"># Create the audio augmentation pipeline</span>
<span class="c1">#</span>

<span class="c1"># Install the other 3rd party packages required from preprocessing</span>
<span class="n">install_pip_package</span><span class="p">(</span><span class="s1">'audiomentations'</span><span class="p">)</span>
<span class="n">install_pip_package</span><span class="p">(</span><span class="s1">'noisereduce'</span><span class="p">)</span>
<span class="n">install_pip_package</span><span class="p">(</span><span class="s1">'pyloudnorm'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">librosa</span>
<span class="kn">import</span> <span class="nn">audiomentations</span>
<span class="kn">import</span> <span class="nn">noisereduce</span>
<span class="kn">import</span> <span class="nn">pyloudnorm</span>

<span class="k">def</span> <span class="nf">audio_augmentation_pipeline</span><span class="p">(</span>
    <span class="n">path_batch</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">label_batch</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">seed</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Augment a batch of audio clips and generate spectrograms</span>

<span class="sd">    This does the following, for each audio file path in the input batch:</span>
<span class="sd">    1. Read audio file</span>
<span class="sd">    2. Adjust its length to fit within the specified length</span>
<span class="sd">    3. Apply random augmentations to the audio sample using audiomentations</span>
<span class="sd">    4. Convert to the specified sample rate (if necessary)</span>
<span class="sd">    5. Generate a spectrogram from the augmented audio sample</span>
<span class="sd">    6. Dump the augmented audio and spectrogram (if necessary)</span>

<span class="sd">    NOTE: This will be execute in parallel across *separate* subprocesses.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        path_batch: Batch of audio file paths</span>
<span class="sd">        label_batch: Batch of corresponding labels</span>
<span class="sd">        seed: Batch of seeds to use for random number generation,</span>
<span class="sd">            This ensures that the "random" augmentations are reproducible</span>

<span class="sd">    Return:</span>
<span class="sd">        Generated batch of spectrograms from augmented audio samples</span>
<span class="sd">    """</span>
    <span class="n">batch_length</span> <span class="o">=</span> <span class="n">path_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">spectrogram_shape</span>
    <span class="n">x_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_length</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

    <span class="c1"># This is the amount of padding we add to the beginning of the sample</span>
    <span class="c1"># This allows for "warming up" the noise reduction block</span>
    <span class="n">padding_length_ms</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">padded_frontend_settings</span> <span class="o">=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">padded_frontend_settings</span><span class="o">.</span><span class="n">sample_length_ms</span> <span class="o">+=</span> <span class="n">padding_length_ms</span>

    <span class="c1"># For each audio sample path in the current batch</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">audio_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">path_batch</span><span class="p">,</span> <span class="n">label_batch</span><span class="p">)):</span>
        <span class="n">class_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">rn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="n">use_cropped_sample_as_unknown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">using_silence_as_unknown</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 30% of the time we want to replace this sample</span>
        <span class="c1"># either either silence or a cropped "known" sample</span>
        <span class="k">if</span> <span class="n">class_id</span> <span class="o">==</span> <span class="n">unknown_class_id</span> <span class="ow">and</span> <span class="n">rn</span> <span class="o">&lt;</span> <span class="mf">0.30</span><span class="p">:</span>
            <span class="c1"># 1% of the time we want to replace an "unknown" sample with silence</span>
            <span class="k">if</span> <span class="n">rn</span> <span class="o">&lt;</span> <span class="mf">.01</span><span class="p">:</span>
                <span class="n">using_silence_as_unknown</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">original_sample_rate</span> <span class="o">=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">original_sample_rate</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, find a "known" sample in the current batch</span>
                <span class="c1"># Later, we'll crop this sample and use it as an "unknown" sample</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">batch_length</span><span class="p">))</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">choice_index</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">label_batch</span><span class="p">[</span><span class="n">choice_index</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">audio_path</span> <span class="o">=</span> <span class="n">path_batch</span><span class="p">[</span><span class="n">choice_index</span><span class="p">]</span>
                    <span class="n">use_cropped_sample_as_unknown</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">using_silence_as_unknown</span><span class="p">:</span>
            <span class="c1"># Read the audio file</span>
            <span class="n">sample</span><span class="p">,</span> <span class="n">original_sample_rate</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">read_audio_file</span><span class="p">(</span>
                <span class="n">audio_path</span><span class="p">,</span>
                <span class="n">return_sample_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_numpy</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Normalize the sample's volume</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">pyloudnorm</span><span class="o">.</span><span class="n">normalize</span><span class="o">.</span><span class="n">peak</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">noisereduce</span><span class="o">.</span><span class="n">reduce_noise</span><span class="p">(</span>
                <span class="n">y</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">sr</span><span class="o">=</span><span class="n">original_sample_rate</span><span class="p">,</span>
                <span class="n">stationary</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="c1"># Create a buffer to hold the padded sample</span>
        <span class="n">padding_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">original_sample_rate</span> <span class="o">*</span> <span class="n">padding_length_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">padded_sample_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">original_sample_rate</span> <span class="o">*</span> <span class="n">padded_frontend_settings</span><span class="o">.</span><span class="n">sample_length_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">padded_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">padded_sample_length</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># If we want to crop a "known" sample and use it as an unknown sample</span>
        <span class="k">if</span> <span class="n">use_cropped_sample_as_unknown</span><span class="p">:</span>
            <span class="c1"># Trim any silence from the sample</span>
            <span class="n">trimmed_sample</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">librosa</span><span class="o">.</span><span class="n">effects</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">top_db</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="c1"># Randomly insert 20% to 40% of the trimmed sample into padded sample buffer</span>
            <span class="c1"># Note that the entire trimmed sample is actually added to the padded sample buffer</span>
            <span class="c1"># However, only the part of the sample that is after padding_length_ms will actually be used.</span>
            <span class="c1"># Everything before will eventually be dropped</span>
            <span class="n">trimmed_sample_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trimmed_sample</span><span class="p">)</span>

            <span class="c1"># Ensure the trimmed sample is no longer than 700ms</span>
            <span class="k">if</span> <span class="n">trimmed_sample_length</span> <span class="o">&lt;</span> <span class="mf">.7</span> <span class="o">*</span> <span class="n">original_sample_rate</span><span class="p">:</span>
                <span class="n">cropped_sample_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">.2</span><span class="p">,</span> <span class="mf">.6</span><span class="p">)</span>
                <span class="n">cropped_sample_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trimmed_sample_length</span> <span class="o">*</span> <span class="n">cropped_sample_percent</span><span class="p">)</span>
                <span class="c1"># Add the beginning of the sample to the end of the padded sample buffer.</span>
                <span class="c1"># This simulates the sample streaming into the audio buffer,</span>
                <span class="c1"># but not being fully streamed in when an inference is invoked on the device.</span>
                <span class="c1"># In this case, we want the partial sample to be considered "unknown".</span>
                <span class="n">padded_sample</span><span class="p">[</span><span class="o">-</span><span class="n">cropped_sample_length</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">trimmed_sample</span><span class="p">[:</span><span class="n">cropped_sample_length</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, adjust the audio clip to the length defined in the frontend_settings</span>
            <span class="n">out_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">original_sample_rate</span> <span class="o">*</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_length_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">adjust_length</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span>
                <span class="n">out_length</span><span class="o">=</span><span class="n">out_length</span><span class="p">,</span>
                <span class="n">trim_threshold_db</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">padded_sample</span><span class="p">[</span><span class="n">padding_length</span><span class="p">:</span><span class="n">padding_length</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">sample</span>



        <span class="c1"># Initialize the global audio augmentations instance</span>
        <span class="c1"># NOTE: We want this to be global so that we only initialize it once per subprocess</span>
        <span class="n">audio_augmentations</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'audio_augmentations'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audio_augmentations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">speech_commands_v2</span><span class="o">.</span><span class="n">load_clean_data</span><span class="p">()</span>
            <span class="n">audio_augmentations</span> <span class="o">=</span> <span class="n">audiomentations</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
                <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">transforms</span><span class="o">=</span><span class="p">[</span>
                <span class="c1">#audiomentations.PitchShift(min_semitones=-1, max_semitones=1, p=0.5),</span>
                <span class="n">audiomentations</span><span class="o">.</span><span class="n">TimeStretch</span><span class="p">(</span><span class="n">min_rate</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">max_rate</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
                <span class="n">audiomentations</span><span class="o">.</span><span class="n">Gain</span><span class="p">(</span><span class="n">min_gain_in_db</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">max_gain_in_db</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
                <span class="n">audiomentations</span><span class="o">.</span><span class="n">AddBackgroundNoise</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_dir</span><span class="si">}</span><span class="s1">/_background_noise_/brd2601'</span><span class="p">,</span>
                    <span class="n">min_absolute_rms_in_db</span><span class="o">=-</span><span class="mf">75.0</span><span class="p">,</span>
                    <span class="n">max_absolute_rms_in_db</span><span class="o">=-</span><span class="mf">60.0</span><span class="p">,</span>
                    <span class="n">noise_rms</span><span class="o">=</span><span class="s2">"absolute"</span><span class="p">,</span>
                    <span class="n">lru_cache_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">p</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="p">),</span>
                <span class="n">audiomentations</span><span class="o">.</span><span class="n">AddBackgroundNoise</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_dir</span><span class="si">}</span><span class="s1">/_background_noise_/ambient'</span><span class="p">,</span>
                    <span class="n">min_snr_in_db</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">max_snr_in_db</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                    <span class="n">noise_rms</span><span class="o">=</span><span class="s2">"relative"</span><span class="p">,</span>
                    <span class="n">lru_cache_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">p</span><span class="o">=</span><span class="mf">0.75</span>
                <span class="p">),</span>
                <span class="n">audiomentations</span><span class="o">.</span><span class="n">AddGaussianSNR</span><span class="p">(</span><span class="n">min_snr_in_db</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">max_snr_in_db</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.25</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="s1">'audio_augmentations'</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio_augmentations</span>

        <span class="c1"># Apply random augmentations to the audio sample</span>
        <span class="n">augmented_sample</span> <span class="o">=</span> <span class="n">audio_augmentations</span><span class="p">(</span><span class="n">padded_sample</span><span class="p">,</span> <span class="n">original_sample_rate</span><span class="p">)</span>

        <span class="c1"># Convert the sample rate (if necessary)</span>
        <span class="k">if</span> <span class="n">original_sample_rate</span> <span class="o">!=</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span><span class="p">:</span>
            <span class="n">augmented_sample</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span>
                <span class="n">augmented_sample</span><span class="p">,</span>
                <span class="n">orig_sr</span><span class="o">=</span><span class="n">original_sample_rate</span><span class="p">,</span>
                <span class="n">target_sr</span><span class="o">=</span><span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span>
            <span class="p">)</span>

        <span class="c1"># Ensure the sample values are within (-1,1)</span>
        <span class="n">augmented_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">augmented_sample</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Generate a spectrogram from the augmented audio sample</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">apply_frontend</span><span class="p">(</span>
            <span class="n">sample</span><span class="o">=</span><span class="n">augmented_sample</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="n">padded_frontend_settings</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="p">)</span>

        <span class="c1"># The input audio sample was padded with padding_length_ms of background noise</span>
        <span class="c1"># Drop the background noise from the final spectrogram used for training</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">spectrogram</span><span class="p">[</span><span class="o">-</span><span class="n">height</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># The output spectrogram is 2D, add a channel dimension to make it 3D:</span>
        <span class="c1"># (height, width, channels=1)</span>
        <span class="n">spectrogram</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">x_batch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrogram</span>

        <span class="c1"># Dump the augmented audio sample AND corresponding spectrogram (if necessary)</span>
        <span class="n">data_dump_dir</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'data_dump_dir'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_dump_dir</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">cv2</span> <span class="kn">import</span> <span class="n">cv2</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">cv2</span>

            <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">audio_path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
            <span class="n">audio_dump_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">data_dump_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">seed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.wav'</span>
            <span class="n">spectrogram_dumped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">spectrogram</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Transpose to put the time on the x-axis</span>
            <span class="n">spectrogram_dumped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">spectrogram_dumped</span><span class="p">)</span>
            <span class="c1"># Convert from int8 to uint8</span>
            <span class="n">spectrogram_dumped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">spectrogram_dumped</span> <span class="o">+</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="n">spectrogram_dumped</span> <span class="o">=</span> <span class="n">spectrogram_dumped</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="c1"># Increase the size of the spectrogram to make it easier to see as a jpeg</span>
            <span class="n">spectrogram_dumped</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">spectrogram_dumped</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">width</span><span class="o">*</span><span class="mi">3</span><span class="p">))</span>

            <span class="n">valid_sample_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_length_ms</span> <span class="o">*</span> <span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">valid_augmented_sample</span> <span class="o">=</span> <span class="n">augmented_sample</span><span class="p">[</span><span class="o">-</span><span class="n">valid_sample_length</span><span class="p">:]</span>
            <span class="n">audio_dump_path</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">write_audio_file</span><span class="p">(</span>
                <span class="n">audio_dump_path</span><span class="p">,</span>
                <span class="n">valid_augmented_sample</span><span class="p">,</span>
                <span class="n">sample_rate</span><span class="o">=</span><span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span>
            <span class="p">)</span>
            <span class="n">image_dump_path</span> <span class="o">=</span> <span class="n">audio_dump_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.wav'</span><span class="p">,</span> <span class="s1">'.jpg'</span><span class="p">)</span>
            <span class="n">jpg_data</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">spectrogram_dumped</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_HOT</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">image_dump_path</span><span class="p">,</span> <span class="n">jpg_data</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">x_batch</span>


<span class="c1">##########################################################################</span>
<span class="c1"># Define the MltkDataset object</span>
<span class="c1"># NOTE: This class is optional but is useful for organizing the code</span>
<span class="c1">#</span>
<span class="k">class</span> <span class="nc">MyDataset</span><span class="p">(</span><span class="n">mltk_core</span><span class="o">.</span><span class="n">MltkDataset</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">subset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">test</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Load the dataset subset</span>

<span class="sd">        This is called automatically by the MLTK before training</span>
<span class="sd">        or evaluation.</span>

<span class="sd">        Args:</span>
<span class="sd">            subset: The dataset subset to return: 'training' or 'evaluation'</span>
<span class="sd">            test: This is optional, it is used when invoking a training "dryrun", e.g.: mltk train audio_tf_dataset-test</span>
<span class="sd">                If this is true, then only return a small portion of the dataset for testing purposes</span>

<span class="sd">        Return:</span>
<span class="sd">            if subset == training:</span>
<span class="sd">                A tuple, (train_dataset, None, validation_dataset)</span>
<span class="sd">            else:</span>
<span class="sd">                validation_dataset</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">'training'</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_subset</span><span class="p">(</span><span class="s1">'training'</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
            <span class="n">validation_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_subset</span><span class="p">(</span><span class="s1">'validation'</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">validation_data</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_subset</span><span class="p">(</span><span class="s1">'validation'</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">unload_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Unload the dataset by shutting down the processing pools"""</span>
        <span class="k">for</span> <span class="n">pool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">load_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span><span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load the subset"""</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'validation'</span><span class="p">,</span> <span class="s1">'evaluation'</span><span class="p">):</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">validation_split</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">'training'</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="p">(</span><span class="n">validation_split</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">data_dump_dir</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'data_dump_dir'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_dump_dir</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\n\n</span><span class="s1">*** Dumping augmented samples to: </span><span class="si">{</span><span class="n">data_dump_dir</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">my_model</span><span class="o">.</span><span class="n">class_counts</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1"># Download, extract, and clean the "Speech Commands" dataset</span>
        <span class="n">dataset_dir</span> <span class="o">=</span> <span class="n">speech_commands_v2</span><span class="o">.</span><span class="n">load_clean_data</span><span class="p">()</span>
        <span class="n">dataset_background_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_dir</span><span class="si">}</span><span class="s1">/_background_noise_'</span>

        <span class="c1"># Download the synthetic on/off dataset and extract into the speech commands dataset</span>
        <span class="n">download_verify_extract</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">'https://github.com/SiliconLabs/mltk_assets/raw/master/datasets/synthetic_on_off_v1.7z'</span><span class="p">,</span>
            <span class="n">dest_dir</span><span class="o">=</span><span class="n">dataset_dir</span><span class="p">,</span>
            <span class="n">file_hash</span><span class="o">=</span><span class="s1">'0e691aaa4e61c82720b397fb82f5702d8355df11'</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">remove_root_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_dest_dir</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Download the synthetic on/off "unknown" dataset and extract into the speech commands dataset: '_on_off_unknown' sub-directory</span>
        <span class="n">additional_unknown_dataset_dir</span> <span class="o">=</span> <span class="n">download_verify_extract</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">'https://github.com/SiliconLabs/mltk_assets/raw/master/datasets/synthetic_on_off_unknown_v1.7z'</span><span class="p">,</span>
            <span class="n">dest_dir</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_dir</span><span class="si">}</span><span class="s1">/_on_off_unknown'</span><span class="p">,</span>
            <span class="n">file_hash</span><span class="o">=</span><span class="s1">'075c9e513c7830dfd531cef0306d100f4a3fb94b'</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">remove_root_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_dest_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Download the BRD2601 background microphone audio and add it to the _background_noise_/brd2601 of the dataset</span>
        <span class="n">download_verify_extract</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="s1">'https://github.com/SiliconLabs/mltk_assets/raw/master/datasets/brd2601_background_audio.7z'</span><span class="p">,</span>
            <span class="n">dest_dir</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_background_dir</span><span class="si">}</span><span class="s1">/brd2601'</span><span class="p">,</span>
            <span class="n">file_hash</span><span class="o">=</span><span class="s1">'3069A85002965A7830C660343C215EDD4FAE39C6'</span><span class="p">,</span>
            <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">remove_root_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">clean_dest_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Download other ambient background audio and add it to the _background_noise_/ambient of the dataset</span>
        <span class="c1"># See https://mixkit.co/</span>
        <span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-very-crowded-pub-or-party-loop-360.wav'</span><span class="p">,</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-big-crowd-talking-loop-364.wav'</span><span class="p">,</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-restaurant-crowd-talking-ambience-444.wav'</span><span class="p">,</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-keyboard-typing-1386.wav'</span><span class="p">,</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-office-ambience-447.wav'</span><span class="p">,</span>
            <span class="s1">'https://assets.mixkit.co/sfx/download/mixkit-hotel-lobby-with-dining-area-ambience-453.wav'</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">URLS</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">dst_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dataset_background_dir</span><span class="si">}</span><span class="s1">/ambient/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">'</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dst_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst_path</span><span class="p">):</span>
                <span class="n">download_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">dst_path</span><span class="o">=</span><span class="n">dst_path</span><span class="p">)</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">original_sample_rate</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">read_audio_file</span><span class="p">(</span>
                    <span class="n">dst_path</span><span class="p">,</span>
                    <span class="n">return_sample_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">return_numpy</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">audio_utils</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span>
                    <span class="n">sample</span><span class="p">,</span>
                    <span class="n">orig_sr</span><span class="o">=</span><span class="n">original_sample_rate</span><span class="p">,</span>
                    <span class="n">target_sr</span><span class="o">=</span><span class="n">frontend_settings</span><span class="o">.</span><span class="n">sample_rate_hz</span>
                <span class="p">)</span>
                <span class="n">audio_utils</span><span class="o">.</span><span class="n">write_audio_file</span><span class="p">(</span><span class="n">dst_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">16000</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_add_additional_unknown_samples</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">sample_paths</span><span class="p">:</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">split</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">float</span><span class="p">],</span>
            <span class="n">shuffle</span><span class="p">:</span><span class="nb">bool</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">"""This is called by the tf_dataset_utils.load_audio_directory() API</span>
<span class="sd">            Here we add the additional samples in the synthetic_on_off_unknown_v1 dataset to the "unknown" samples</span>
<span class="sd">            """</span>
            <span class="n">unknown_samples</span> <span class="o">=</span> <span class="n">sample_paths</span><span class="p">[</span><span class="s1">'_unknown_'</span><span class="p">]</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">additional_unknown_dataset_dir</span> <span class="o">+</span> <span class="s1">'/unknown'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
                <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

            <span class="n">paths</span> <span class="o">=</span> <span class="n">split_file_list</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="n">unknown_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'_on_off_unknown/unknown/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>


        <span class="c1"># Create a tf.data.Dataset from the extracted "Speech Commands" directory</span>
        <span class="n">max_samples_per_class</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">if</span> <span class="n">test</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">class_counts</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">class_counts</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="k">if</span> <span class="n">subset</span> <span class="k">else</span> <span class="n">my_model</span><span class="o">.</span><span class="n">class_counts</span>
        <span class="n">features_ds</span><span class="p">,</span> <span class="n">labels_ds</span> <span class="o">=</span> <span class="n">tf_dataset_utils</span><span class="o">.</span><span class="n">load_audio_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="o">=</span><span class="n">dataset_dir</span><span class="p">,</span>
            <span class="n">classes</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span>
            <span class="n">onehot_encode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># We're using categorical cross-entropy so one-hot encode the labels</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
            <span class="n">max_samples_per_class</span><span class="o">=</span><span class="n">max_samples_per_class</span><span class="p">,</span>
            <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span>
            <span class="n">unknown_class_percentage</span><span class="o">=</span><span class="n">unknown_class_multiplier</span><span class="p">,</span>
            <span class="n">return_audio_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># We only want to return the file paths</span>
            <span class="n">class_counts</span><span class="o">=</span><span class="n">class_counts</span><span class="p">,</span>
            <span class="n">shuffle_index_directory</span><span class="o">=</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">my_model</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s1">/dataset'</span><span class="p">,</span> <span class="c1"># We want to shuffle ALL of the synthetic samples with the speech_commands samples BEFORE splitting the data into subsets</span>
            <span class="n">process_samples_function</span><span class="o">=</span><span class="n">_add_additional_unknown_samples</span>
        <span class="p">)</span>

        <span class="c1"># We use an incrementing counter as the seed for the random augmentations</span>
        <span class="c1"># This helps to keep the training reproducible</span>
        <span class="n">seed_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
        <span class="n">features_ds</span> <span class="o">=</span> <span class="n">features_ds</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">features_ds</span><span class="p">,</span> <span class="n">labels_ds</span><span class="p">,</span> <span class="n">seed_counter</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">subset</span><span class="p">:</span>
            <span class="c1"># Usage of tf_dataset_utils.parallel_process()</span>
            <span class="c1"># is optional, but can speed-up training as the data augmentations</span>
            <span class="c1"># are spread across the available CPU cores.</span>
            <span class="c1"># Each CPU core gets its own subprocess,</span>
            <span class="c1"># and and subprocess executes audio_augmentation_pipeline() on batches of the dataset.</span>
            <span class="n">per_job_batch_multiplier</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">per_job_batch_size</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">per_job_batch_multiplier</span>
            <span class="n">features_ds</span> <span class="o">=</span> <span class="n">features_ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">per_job_batch_size</span> <span class="o">//</span> <span class="n">per_job_batch_multiplier</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">features_ds</span><span class="p">,</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">tf_dataset_utils</span><span class="o">.</span><span class="n">parallel_process</span><span class="p">(</span>
                <span class="n">features_ds</span><span class="p">,</span>
                <span class="n">audio_augmentation_pipeline</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
                <span class="c1">#n_jobs=84 if subset == 'training' else 32, # These are the settings for a 256 CPU core cloud machine</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="mi">72</span> <span class="k">if</span> <span class="n">subset</span> <span class="o">==</span> <span class="s1">'training'</span> <span class="k">else</span> <span class="mi">32</span><span class="p">,</span> <span class="c1"># These are the settings for a 128 CPU core cloud machine</span>
                <span class="c1">#n_jobs=44 if subset == 'training' else 16, # These are the settings for a 96 CPU core cloud machine</span>
                <span class="c1">#n_jobs=50 if subset == 'training' else 25, # These are the settings for a 84 CPU core cloud machine</span>
                <span class="c1">#n_jobs=36 if subset == 'training' else 18, # These are the settings for a 64 CPU core cloud machine</span>
                <span class="c1">#n_jobs=28 if subset == 'training' else 16, # These are the settings for a 48 CPU core cloud machine</span>
                <span class="c1">#n_jobs=.65 if subset == 'training' else .35,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>
            <span class="n">features_ds</span> <span class="o">=</span> <span class="n">features_ds</span><span class="o">.</span><span class="n">unbatch</span><span class="p">()</span>

            <span class="c1"># Pre-fetching batches can help with throughput</span>
            <span class="n">features_ds</span> <span class="o">=</span> <span class="n">features_ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">per_job_batch_size</span><span class="p">)</span>

        <span class="c1"># Combine the augmented audio samples with their corresponding labels</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">features_ds</span><span class="p">,</span> <span class="n">labels_ds</span><span class="p">))</span>

        <span class="c1"># Shuffle the data for each sample</span>
        <span class="c1"># A perfect shuffle would use n_samples but this can slow down training,</span>
        <span class="c1"># so we just shuffle batches of the data</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">per_job_batch_size</span><span class="p">,</span> <span class="n">reshuffle_each_iteration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># At this point we have a flat dataset of x,y tuples</span>
        <span class="c1"># Batch the data as necessary for training</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

        <span class="c1"># Pre-fetch a couple training batches to aid throughput</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">MyDataset</span><span class="p">()</span>




<span class="c1">#################################################</span>
<span class="c1"># Audio Classifier Settings</span>
<span class="c1">#</span>
<span class="c1"># These are additional parameters to include in</span>
<span class="c1"># the generated .tflite model file.</span>
<span class="c1"># The settings are used by the ble_audio_classifier app</span>
<span class="c1"># NOTE: Corresponding command-line options will override these values.</span>

<span class="c1"># This the amount of time in milliseconds between audio processing loops</span>
<span class="c1"># Since we're using the audio detection block, we want this to be as short as possible</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'latency_ms'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="c1"># The minimum number of inference results to average when calculating the detection value</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'minimum_count'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># Controls the smoothing.</span>
<span class="c1"># Drop all inference results that are older than &lt;now&gt; minus window_duration</span>
<span class="c1"># Longer durations (in milliseconds) will give a higher confidence that the results are correct, but may miss some commands</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'average_window_duration_ms'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'latency_ms'</span><span class="p">]</span><span class="o">*</span><span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'minimum_count'</span><span class="p">]</span><span class="o">*</span><span class="mf">1.1</span><span class="p">)</span>
<span class="c1"># Define a specific detection threshold for each class</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'detection_threshold'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">.65</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span>
<span class="c1"># Amount of milliseconds to wait after a keyword is detected before detecting the SAME keyword again</span>
<span class="c1"># A different keyword may be detected immediately after</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'suppression_ms'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">900</span>
<span class="c1"># Set the volume gain scaler (i.e. amplitude) to apply to the microphone data. If 0 or omitted, no scaler is applied</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'volume_gain'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Enable verbose inference results</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'verbose_model_output_logs'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>




<span class="c1">#################################################</span>
<span class="c1"># Student/Teacher training config</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">get_teacher_h5_path</span><span class="p">(</span><span class="n">try_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_exists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return the file path to the trained "teacher" keras model"""</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">'.teacher.test.h5'</span> <span class="k">if</span> <span class="n">my_model</span><span class="o">.</span><span class="n">test_mode_enabled</span> <span class="k">else</span> <span class="s1">'.teacher.h5'</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">try_archive</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">get_archive_file</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">my_model</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">model_specification_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'.py'</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">check_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">retval</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">'Teacher keras model not found: </span><span class="si">{</span><span class="n">retval</span><span class="si">}</span><span class="se">\n</span><span class="s1">'</span>
            <span class="s1">'Have you trained the teacher model first?</span><span class="se">\n</span><span class="s1">'</span>
            <span class="s1">'e.g.:</span><span class="se">\n</span><span class="s1">export TRAIN_TEACHER=1</span><span class="se">\n</span><span class="s1">'</span>
            <span class="s1">'mltk train keyword_spotting_on_off_v2'</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">retval</span>


<span class="k">def</span> <span class="nf">prepare_teacher_or_student_model</span><span class="p">(</span><span class="n">train_teacher</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""This prepares the model for "teacher" or "student" training</span>

<span class="sd">    This is based on the given train_teacher argument or enviroment variable: TRAIN_TEACHER</span>
<span class="sd">    """</span>
    <span class="c1"># Use the given argument or retrieve the TRAIN_TEACHER environment variable</span>
    <span class="k">if</span> <span class="n">train_teacher</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">train_teacher</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TRAIN_TEACHER'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'1'</span>

    <span class="n">my_model</span><span class="o">.</span><span class="n">ssh_environment</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">TRAIN_TEACHER</span><span class="o">=</span><span class="s1">'1'</span> <span class="k">if</span> <span class="n">train_teacher</span> <span class="k">else</span> <span class="s1">'0'</span>
    <span class="p">)</span>

    <span class="c1"># If we're training the teacher then update the model properties for that</span>
    <span class="k">if</span> <span class="n">train_teacher</span><span class="p">:</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">build_model_function</span> <span class="o">=</span> <span class="n">my_teacher_model_builder</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">on_save_keras_model</span> <span class="o">=</span> <span class="n">my_teacher_model_saver</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">early_stopping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">monitor</span><span class="o">=</span><span class="s1">'val_accuracy'</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">patience</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
            <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.0001</span>
        <span class="p">)</span>
        <span class="n">teacher_h5_path</span> <span class="o">=</span> <span class="n">get_teacher_h5_path</span><span class="p">(</span><span class="n">check_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">ssh_upload_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">)]</span>

        <span class="c1"># Download the teacher's keras model (.h5) as keyword_spotting_on_off_v2.teacher.h5 after training completes</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">ssh_download_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'~/.mltk/models/</span><span class="si">{</span><span class="n">my_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">h5_log_dir_path</span><span class="p">)</span><span class="si">}</span><span class="s1">|</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">teacher_h5_path</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise we're training the student model</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">build_model_function</span> <span class="o">=</span> <span class="n">my_student_model_builder</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">on_save_keras_model</span> <span class="o">=</span> <span class="n">my_student_model_saver</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'optimizations'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Optimize</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">]</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'supported_ops'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">OpsSet</span><span class="o">.</span><span class="n">TFLITE_BUILTINS_INT8</span><span class="p">]</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'inference_input_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'inference_output_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
        <span class="c1"># Automatically generate a representative dataset from the validation data</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span><span class="p">[</span><span class="s1">'representative_dataset'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'generate'</span>

        <span class="c1"># Upload the teacher's keras model (.h5) as keyword_spotting_on_off_v2.teacher.h5 before training starts</span>
        <span class="n">my_model</span><span class="o">.</span><span class="n">ssh_upload_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">get_teacher_h5_path</span><span class="p">())]</span>



<span class="c1"># By default, when this model is loaded,</span>
<span class="c1"># Prepare the teacher or student model based on the environment variable: TRAIN_TEACHER</span>
<span class="n">prepare_teacher_or_student_model</span><span class="p">()</span>


<span class="c1">##########################################################################################</span>
<span class="c1"># The following allows for running this model training script directly, e.g.:</span>
<span class="c1"># python keyword_spotting_on_off_v2.py</span>
<span class="c1">#</span>
<span class="c1"># Note that this has the same functionality as:</span>
<span class="c1"># mltk train keyword_spotting_on_off_v2</span>
<span class="c1">#</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mltk</span> <span class="kn">import</span> <span class="n">cli</span>

    <span class="c1"># Setup the CLI logger</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If this is true then this will do a "dry run" of the model testing</span>
    <span class="c1"># If this is false, then the model will be fully trained</span>
    <span class="n">test_mode_enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Train the "teacher" model</span>
    <span class="c1"># This does the same as issuing the command: export TRAIN_TEACHER=1 &amp;&amp; mltk train keyword_spotting_on_off_v2-test --clean</span>
    <span class="n">prepare_teacher_or_student_model</span><span class="p">(</span><span class="n">train_teacher</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">train_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_results</span><span class="p">)</span>

    <span class="c1"># Train the "student" model</span>
    <span class="c1"># This does the same as issuing the command: export TRAIN_TEACHER=0 &amp;&amp; mltk train keyword_spotting_on_off_v2-test --clean</span>
    <span class="n">prepare_teacher_or_student_model</span><span class="p">(</span><span class="n">train_teacher</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">train_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_results</span><span class="p">)</span>

    <span class="c1"># Evaluate the model against the quantized .h5 (i.e. float32) model</span>
    <span class="c1"># This does the same as issuing the command: mltk evaluate keyword_spotting_on_off_v2-test</span>
    <span class="n">tflite_eval_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tflite_eval_results</span><span class="p">)</span>

    <span class="c1"># Profile the model in the simulator</span>
    <span class="c1"># This does the same as issuing the command: mltk profile keyword_spotting_on_off_v2-test</span>
    <span class="n">profiling_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">profile_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">profiling_results</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </article>
        </div>
      </div>
      <a href="#" class="go-top"><i class="md-icon">arrow_upward</i>Back to Top</a>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="keyword_spotting_on_off.html" title="keyword_spotting_on_off"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> keyword_spotting_on_off </span>
              </div>
            </a>
          
          
            <a href="keyword_spotting_on_off_v3.html" title="keyword_spotting_on_off_v3"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> keyword_spotting_on_off_v3 </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, Silicon Labs.
              
          </div>
            Last updated on
              Apr 02, 2024.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <div class="privacy-banner">
    <div class="privacy-banner-wrapper">
      <p>
        <b>Important:</b> We use cookies only for functional and traffic analytics. <br />
        We DO NOT use cookies for any marketing purposes. By using our site you acknowledge you have read and understood our <a class="privacy-policy" href="https://www.silabs.com/about-us/legal/cookie-policy" target="_blank">Cookie Policy</a>.
      </p>
      <a class="privacy-banner-accept" href="#">Got it</a>
    </div>
</div>
  <script src="../../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>