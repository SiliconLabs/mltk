
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="title" content="Machine Learning Toolkit">
<meta name="description" content="A Python package with command-line utilities and scripts to aid the development of machine learning models for Silicon Lab's embedded platforms">
<meta name="keywords" content="machine learning, machine-learning, machinelearning, ml, ai, iot, Internet of things, aiot, tinyml, tensorflow, tensorflow-lite, tensorflow-lite-micro, keras-tensorflow, keras, tflite, embedded, embedded-systems, mcu, Microcontrollers, hardware, python, c++, cmake, keras, numpy, silabs, silicon labs">
<meta name="robots" content="index, follow">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="language" content="English">
<meta name="author" content="Silicon Labs">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HZ5MW943WF"></script>
<script>
    window.gTrackingId = 'G-HZ5MW943WF';
</script>
<meta name="google-site-verification" content="dsSsmnE2twOnfSAQk5zBBTrjMArsTJj809Bp-8mVlIw" />
  
  
    <title>fingerprint_signature_generator &#8212; MLTK 0.15.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script src="../../../../_static/js/custom.js"></script>
    <script src="../../../../_static/js/apitoc.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="TinyML Models" href="../tinyml/index.html" />
    <link rel="prev" title="rock_paper_scissors" href="rock_paper_scissors.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=red data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#docs/python_api/models/siliconlabs/fingerprint_signature_generator" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../../index.html" title="MLTK 0.15.0 documentation"
           class="md-header-nav__button md-logo">
          
              <img src="../../../../_static/logo.png"
                   alt="MLTK 0.15.0 documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Machine Learning Toolkit</span>
          <span class="md-header-nav__topic"> fingerprint_signature_generator </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="https://docs.silabs.com/gecko-platform/latest/machine-learning/tensorflow/overview" class="md-tabs__link">Gecko SDK Documentation</a></li>
            
            <li class="md-tabs__item"><a href="https://github.com/tensorflow/tflite-micro" class="md-tabs__link">Tensorflow-Lite Micro Repository</a></li>
            
            <li class="md-tabs__item"><a href="https://www.tensorflow.org/learn" class="md-tabs__link">Tensorflow Documentation</a></li>
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">Reference Models</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Silicon Labâ€™s Models</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../../index.html" title="MLTK 0.15.0 documentation" class="md-nav__button md-logo">
      
        <img src="../../../../_static/logo.png" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../../index.html"
       title="MLTK 0.15.0 documentation">Machine Learning Toolkit</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/siliconlabs/mltk" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    MLTK Github Repository
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Basics</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../overview.html" class="md-nav__link">Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../why_mltk.html" class="md-nav__link">Why MLTK?</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../installation.html" class="md-nav__link">Installation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../command_line/index.html" class="md-nav__link">Command-Line</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/index.html" class="md-nav__link">Modeling Guides</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Usage</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../tutorials.html" class="md-nav__link">Tutorials</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../examples.html" class="md-nav__link">API Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../index.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../index.html" class="md-nav__link">Reference Models</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="../examples/index.html" class="md-nav__link">Example Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">Silicon Labâ€™s Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tinyml/index.html" class="md-nav__link">TinyML Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../tflite_micro/index.html" class="md-nav__link">Tensorflow-Lite Micro Models</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../common_models.html" class="md-nav__link">Common Model Architectures</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../datasets/index.html" class="md-nav__link">Reference Datasets</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/index.html" class="md-nav__link">C++ Development</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../cpp_development/examples/index.html" class="md-nav__link">C++ Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Audio Related</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/keyword_spotting_overview.html" class="md-nav__link">Keyword Spotting Overview</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_feature_generator.html" class="md-nav__link">Audio Feature Generator</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../audio/audio_utilities.html" class="md-nav__link">Audio Utilities</a>
      
    
    </li>
    <li class="md-nav__item">
    
      <span class="md-nav__link caption"><span class="caption-text">Other Information</span></span>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../faq/index.html" class="md-nav__link">Frequently Asked Questions</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/quick_reference.html" class="md-nav__link">Quick Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/supported_hardware.html" class="md-nav__link">Supported Hardware</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../guides/notebook_examples_guide.html" class="md-nav__link">Notebook Examples Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/settings_file.html" class="md-nav__link">Settings File</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../other/environment_variables.html" class="md-nav__link">Environment Variables</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="" id="localtoc">
        <li class="md-nav__item"><a href="#docs-python-api-models-siliconlabs-fingerprint-signature-generator--page-root" class="md-nav__link">fingerprint_signature_generator</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#commands" class="md-nav__link">Commands</a>
        </li>
        <li class="md-nav__item"><a href="#model-summary" class="md-nav__link">Model Summary</a>
        </li>
        <li class="md-nav__item"><a href="#model-profiling-report" class="md-nav__link">Model Profiling Report</a>
        </li>
        <li class="md-nav__item"><a href="#model-diagram" class="md-nav__link">Model Diagram</a>
        </li>
        <li class="md-nav__item"><a href="#model-specification" class="md-nav__link">Model Specification</a>
        </li></ul>
            </nav>
        </li>
      <script type="text/javascript" src=../../../../_static/js/apitoc.js></script>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">

          
          <div class="breadcrumbs md-typeset">
            <ul class="breadcrumb">
              <li></li>
              <li><a href="../../../../index.html"><i class="md-icon">home</i></a></li>
                <li><a href="../index.html" >Reference Models</a></li>
                <li><a href="index.html" accesskey="U">Silicon Labâ€™s Models</a></li>

              <li class="activate"><a>fingerprint_signature_generator</a></li>
            </ul>
          </div>
          

          <article class="md-content__inner md-typeset" role="main">
            
  <span class="target" id="module-mltk.models.siliconlabs.fingerprint_signature_generator"></span><section id="fingerprint-signature-generator">
<h1 id="docs-python-api-models-siliconlabs-fingerprint-signature-generator--page-root">fingerprint_signature_generator<a class="headerlink" href="#docs-python-api-models-siliconlabs-fingerprint-signature-generator--page-root" title="Permalink to this heading">Â¶</a></h1>
<ul class="simple">
<li><p>Source code: <a class="reference external" href="https://github.com/siliconlabs/mltk/blob/master/mltk/models/siliconlabs/fingerprint_signature_generator.py">fingerprint_signature_generator.py</a></p></li>
<li><p>Pre-trained model: <a class="reference external" href="https://github.com/siliconlabs/mltk/blob/master/mltk/models/siliconlabs/fingerprint_signature_generator.mltk.zip">fingerprint_signature_generator.mltk.zip</a>.</p></li>
</ul>
<p>This model was adapted from <a class="reference external" href="https://keras.io/examples/vision/siamese_contrastive">Image similarity estimation using a Siamese Network with a contrastive loss</a>.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Siamese_neural_network">Siamese Networks</a> are neural networks which share weights between two or more sister networks,
each producing embedding vectors of its respective inputs.</p>
<p>In supervised similarity learning, the networks are then trained to maximize the contrast (distance) between embeddings of inputs of different classes,
while minimizing the distance between embeddings of similar classes, resulting in embedding spaces that reflect the class segmentation of the training inputs.</p>
<p>Refer to the <a class="reference external" href="../../../../mltk/tutorials/fingerprint_authentication.html">Fingerprint Authentication Tutorial</a> for more details.</p>
<section id="commands">
<h2 id="commands">Commands<a class="headerlink" href="#commands" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do a "dry run" test training of the model</span>
mltk<span class="w"> </span>train<span class="w"> </span>fingerprint_signature_generator-test

<span class="c1"># Train the model</span>
mltk<span class="w"> </span>train<span class="w"> </span>fingerprint_signature_generator

<span class="c1"># Evaluate the trained model .tflite model</span>
mltk<span class="w"> </span>evaluate<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--tflite

<span class="c1"># Profile the model in the MVP hardware accelerator simulator</span>
mltk<span class="w"> </span>profile<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--accelerator<span class="w"> </span>MVP

<span class="c1"># Profile the model on a physical development board</span>
mltk<span class="w"> </span>profile<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--accelerator<span class="w"> </span>MVP<span class="w"> </span>--device

<span class="c1"># Model command to dump the preprocessed dataset</span>
mltk<span class="w"> </span>custom<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>dump

<span class="c1"># Model command to compare the raw vs preprocessed dataset images</span>
mltk<span class="w"> </span>custom<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>preprocess<span class="w"> </span>--count<span class="w"> </span><span class="m">200</span>

<span class="c1"># Run this model in the fingerprint_reader application</span>
mltk<span class="w"> </span>fingerprint_reader<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--dump-images
</pre></div>
</div>
</section>
<section id="model-summary">
<h2 id="model-summary">Model Summary<a class="headerlink" href="#model-summary" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mltk<span class="w"> </span>summarize<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--tflite

+-------+-------------------+------------------+-----------------+-------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Index<span class="w"> </span><span class="p">|</span><span class="w"> </span>OpCode<span class="w">            </span><span class="p">|</span><span class="w"> </span>Input<span class="o">(</span>s<span class="o">)</span><span class="w">         </span><span class="p">|</span><span class="w"> </span>Output<span class="o">(</span>s<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span>Config<span class="w">                                                </span><span class="p">|</span>
+-------+-------------------+------------------+-----------------+-------------------------------------------------------+
<span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>depthwise_conv_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span>180x180x1<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>88x88x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Multiplier:8<span class="w"> </span>padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>activation:relu<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span>5x5x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w">   </span><span class="p">|</span><span class="w"> </span>88x88x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>44x44x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w">   </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">           </span><span class="p">|</span><span class="w"> </span>44x44x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">   </span><span class="p">|</span><span class="w"> </span>42x42x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:relu<span class="w">              </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span>3x3x8<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">     </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>mean<span class="w">              </span><span class="p">|</span><span class="w"> </span>42x42x16<span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>reduceroptions<span class="w">                                   </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w"> </span>Activation:none<span class="w">                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int8<span class="o">)</span><span class="w">        </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
<span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">16</span><span class="w"> </span><span class="o">(</span>int32<span class="o">)</span><span class="w">       </span><span class="p">|</span><span class="w">                 </span><span class="p">|</span><span class="w">                                                       </span><span class="p">|</span>
+-------+-------------------+------------------+-----------------+-------------------------------------------------------+
Total<span class="w"> </span>MACs:<span class="w"> </span><span class="m">3</span>.581<span class="w"> </span>M
Total<span class="w"> </span>OPs:<span class="w"> </span><span class="m">7</span>.330<span class="w"> </span>M
Name:<span class="w"> </span>fingerprint_signature_generator
Version:<span class="w"> </span><span class="m">1</span>
Description:<span class="w"> </span>Fingerprint<span class="w"> </span><span class="s2">"signature"</span><span class="w"> </span>generator<span class="w"> </span>estimation<span class="w"> </span>using<span class="w"> </span>a<span class="w"> </span>Siamese<span class="w"> </span>Network<span class="w"> </span>with<span class="w"> </span>a<span class="w"> </span>contrastive<span class="w"> </span>loss
Classes:<span class="w"> </span>match,<span class="w"> </span>no-match
hash:<span class="w"> </span>c5b17e1deffd907e823bfadf519b2d5d
date:<span class="w"> </span><span class="m">2022</span>-05-24T22:34:55.383Z
runtime_memory_size:<span class="w"> </span><span class="m">95964</span>
threshold:<span class="w"> </span><span class="m">0</span>.18000000715255737
sharpen_filter:<span class="w"> </span>b<span class="s1">'Ã¾Ã½Ã½Ã½Ã¾Ã½Ã½Ã½Ã½Ã½Ã½Ã½dÃ½Ã½Ã½Ã½Ã½Ã½Ã½Ã¾Ã½Ã½Ã½Ã¾'</span>
sharpen_filter_width:<span class="w"> </span><span class="m">5</span>
sharpen_filter_height:<span class="w"> </span><span class="m">5</span>
sharpen_gain:<span class="w"> </span><span class="m">32</span>
balance_threshold_max:<span class="w"> </span><span class="m">240</span>
balance_threshold_min:<span class="w"> </span><span class="m">0</span>
border:<span class="w"> </span><span class="m">32</span>
verify_imin:<span class="w"> </span><span class="m">32</span>
verify_imax:<span class="w"> </span><span class="m">224</span>
verify_full_threshold:<span class="w"> </span><span class="m">3</span>
verify_center_threshold:<span class="w"> </span><span class="m">2</span>
samplewise_norm.rescale:<span class="w"> </span><span class="m">0</span>.0
samplewise_norm.mean_and_std:<span class="w"> </span>False
.tflite<span class="w"> </span>file<span class="w"> </span>size:<span class="w"> </span><span class="m">6</span>.5kB
</pre></div>
</div>
</section>
<section id="model-profiling-report">
<h2 id="model-profiling-report">Model Profiling Report<a class="headerlink" href="#model-profiling-report" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Profile on physical EFR32xG24 using MVP accelerator</span>
mltk<span class="w"> </span>profile<span class="w"> </span>fingerprint_signature_generator<span class="w"> </span>--device<span class="w"> </span>--accelerator<span class="w"> </span>MVP

<span class="w"> </span>Profiling<span class="w"> </span>Summary
<span class="w"> </span>Name:<span class="w"> </span>fingerprint_signature_generator
<span class="w"> </span>Accelerator:<span class="w"> </span>MVP
<span class="w"> </span>Input<span class="w"> </span>Shape:<span class="w"> </span>1x180x180x1
<span class="w"> </span>Input<span class="w"> </span>Data<span class="w"> </span>Type:<span class="w"> </span>int8
<span class="w"> </span>Output<span class="w"> </span>Shape:<span class="w"> </span>1x16
<span class="w"> </span>Output<span class="w"> </span>Data<span class="w"> </span>Type:<span class="w"> </span>int8
<span class="w"> </span>Flash,<span class="w"> </span>Model<span class="w"> </span>File<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>:<span class="w"> </span><span class="m">6</span>.4k
<span class="w"> </span>RAM,<span class="w"> </span>Runtime<span class="w"> </span>Memory<span class="w"> </span>Size<span class="w"> </span><span class="o">(</span>bytes<span class="o">)</span>:<span class="w"> </span><span class="m">143</span>.0k
<span class="w"> </span>Operation<span class="w"> </span>Count:<span class="w"> </span><span class="m">7</span>.5M
<span class="w"> </span>Multiply-Accumulate<span class="w"> </span>Count:<span class="w"> </span><span class="m">3</span>.6M
<span class="w"> </span>Layer<span class="w"> </span>Count:<span class="w"> </span><span class="m">5</span>
<span class="w"> </span>Unsupported<span class="w"> </span>Layer<span class="w"> </span>Count:<span class="w"> </span><span class="m">0</span>
<span class="w"> </span>Accelerator<span class="w"> </span>Cycle<span class="w"> </span>Count:<span class="w"> </span><span class="m">4</span>.1M
<span class="w"> </span>CPU<span class="w"> </span>Cycle<span class="w"> </span>Count:<span class="w"> </span><span class="m">5</span>.4M
<span class="w"> </span>CPU<span class="w"> </span>Utilization<span class="w"> </span><span class="o">(</span>%<span class="o">)</span>:<span class="w"> </span><span class="m">57</span>.4
<span class="w"> </span>Clock<span class="w"> </span>Rate<span class="w"> </span><span class="o">(</span>hz<span class="o">)</span>:<span class="w"> </span><span class="m">78</span>.0M
<span class="w"> </span>Time<span class="w"> </span><span class="o">(</span>s<span class="o">)</span>:<span class="w"> </span><span class="m">119</span>.7m
<span class="w"> </span>Ops/s:<span class="w"> </span><span class="m">62</span>.7M
<span class="w"> </span>MACs/s:<span class="w"> </span><span class="m">29</span>.8M
<span class="w"> </span>Inference/s:<span class="w"> </span><span class="m">8</span>.4

<span class="w"> </span>Model<span class="w"> </span>Layers
<span class="w"> </span>+-------+-------------------+-------+--------+------------+------------+----------+-----------------------+--------------+-------------------------------------------------------+
<span class="w"> </span><span class="p">|</span><span class="w"> </span>Index<span class="w"> </span><span class="p">|</span><span class="w"> </span>OpCode<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="c1"># Ops | # MACs | Acc Cycles | CPU Cycles | Time (s) | Input Shape           | Output Shape | Options                                               |</span>
<span class="w"> </span>+-------+-------------------+-------+--------+------------+------------+----------+-----------------------+--------------+-------------------------------------------------------+
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>depthwise_conv_2d<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.3M<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.5M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.5M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">33</span>.2k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">31</span>.5m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x180x180x1,1x5x5x8,8<span class="w"> </span><span class="p">|</span><span class="w"> </span>1x88x88x8<span class="w">    </span><span class="p">|</span><span class="w"> </span>Multiplier:8<span class="w"> </span>padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>activation:relu<span class="w"> </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">1</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>average_pool_2d<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">77</span>.4k<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">54</span>.3k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.8M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">23</span>.8m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x88x88x8<span class="w">             </span><span class="p">|</span><span class="w"> </span>1x44x44x8<span class="w">    </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:2x2<span class="w"> </span>filter:2x2<span class="w"> </span>activation:none<span class="w">   </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">2</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>conv_2d<span class="w">           </span><span class="p">|</span><span class="w"> </span><span class="m">4</span>.1M<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.0M<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.6M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">10</span>.6k<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">20</span>.4m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x44x44x8,16x3x3x8,16<span class="w"> </span><span class="p">|</span><span class="w"> </span>1x42x42x16<span class="w">   </span><span class="p">|</span><span class="w"> </span>Padding:valid<span class="w"> </span>stride:1x1<span class="w"> </span>activation:relu<span class="w">              </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">3</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>mean<span class="w">              </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">     </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">0</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.5M<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">43</span>.9m<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x42x42x16,2<span class="w">          </span><span class="p">|</span><span class="w"> </span>1x16<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="nv">Type</span><span class="o">=</span>reduceroptions<span class="w">                                   </span><span class="p">|</span>
<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">4</span><span class="w">     </span><span class="p">|</span><span class="w"> </span>fully_connected<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">528</span>.0<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">256</span>.0<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">496</span>.0<span class="w">      </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.2k<span class="w">       </span><span class="p">|</span><span class="w"> </span><span class="m">30</span>.0u<span class="w">    </span><span class="p">|</span><span class="w"> </span>1x16,16x16,16<span class="w">         </span><span class="p">|</span><span class="w"> </span>1x16<span class="w">         </span><span class="p">|</span><span class="w"> </span>Activation:none<span class="w">                                       </span><span class="p">|</span>
<span class="w"> </span>+-------+-------------------+-------+--------+------------+------------+----------+-----------------------+--------------+-------------------------------------------------------+
</pre></div>
</div>
</section>
<section id="model-diagram">
<h2 id="model-diagram">Model Diagram<a class="headerlink" href="#model-diagram" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mltk<span class="w"> </span>view<span class="w">  </span>fingerprint_signature_generator<span class="w"> </span>--tflite
</pre></div>
</div>
<div class="model-diagram">
<a href="../../../../_images/models/fingerprint_signature_generator.tflite.png" target="_blank">
<img src="../../../../_images/models/fingerprint_signature_generator.tflite.png"/>
<p>Click to enlarge</p>
</a>
</div></section>
<section id="model-specification">
<h2 id="model-specification">Model Specification<a class="headerlink" href="#model-specification" title="Permalink to this heading">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tqdm</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">typer</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mltk.core.keras</span> <span class="kn">import</span> <span class="p">(</span><span class="n">img_to_array</span><span class="p">,</span> <span class="n">load_img</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">mltk.core.model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MltkModel</span><span class="p">,</span>
    <span class="n">TrainMixin</span><span class="p">,</span>
    <span class="n">ImageDatasetMixin</span><span class="p">,</span>
    <span class="n">EvaluateMixin</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mltk.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_tflite_or_keras_model</span><span class="p">,</span>
    <span class="n">KerasModel</span><span class="p">,</span>
    <span class="n">TfliteModel</span><span class="p">,</span>
    <span class="n">EvaluationResults</span><span class="p">,</span>
    <span class="n">ClassifierEvaluationResults</span><span class="p">,</span>
    <span class="n">TrainingResults</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">mltk.core.tflite_model.tflite_model</span> <span class="kn">import</span> <span class="n">TfliteModel</span>
<span class="kn">from</span> <span class="nn">mltk.core.preprocess.image.parallel_generator</span> <span class="kn">import</span> <span class="n">ParallelImageDataGenerator</span><span class="p">,</span> <span class="n">ParallelProcessParams</span>
<span class="kn">from</span> <span class="nn">mltk.core.keras.losses</span> <span class="kn">import</span> <span class="n">ContrastiveLoss</span>

<span class="kn">from</span> <span class="nn">mltk.models.siliconlabs.fingerprint_signature_generator_dataset</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FingerprintSignatureGeneratorDataset</span><span class="p">,</span>
    <span class="n">euclidean_distance</span>
<span class="p">)</span>

<span class="c1"># @mltk_model # NOTE: This tag is required for this model be discoverable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span>
    <span class="n">MltkModel</span><span class="p">,</span>
    <span class="n">TrainMixin</span><span class="p">,</span>
    <span class="n">ImageDatasetMixin</span><span class="p">,</span>
    <span class="n">EvaluateMixin</span>
<span class="p">):</span>
    <span class="k">pass</span>
<span class="n">my_model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>



<span class="c1">###################################################################################################</span>
<span class="c1"># General Model Settings</span>
<span class="c1">###################################################################################################</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">'Fingerprint "signature" generator estimation using a Siamese Network with a contrastive loss'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">ContrastiveLoss</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="c1"># We need to save reference to the custom loss function</span>
<span class="c1"># so that we can load the .h5 file</span>
<span class="c1"># See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">keras_custom_objects</span><span class="p">[</span><span class="s1">'ContrastiveLoss'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContrastiveLoss</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">keras_custom_objects</span><span class="p">[</span><span class="s1">'euclidean_distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">euclidean_distance</span>


<span class="n">my_model</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'accuracy'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s1">'adam'</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">reduce_lr_on_plateau</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
  <span class="n">monitor</span><span class="o">=</span><span class="s1">'loss'</span><span class="p">,</span>
  <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
  <span class="n">patience</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">min_delta</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span>
  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># https://keras.io/api/callbacks/early_stopping/</span>
<span class="c1"># If the validation accuracy doesn't improve after 'patience' epochs then stop training</span>
<span class="c1"># my_model.early_stopping = dict(</span>
<span class="c1">#   monitor = 'val_accuracy',</span>
<span class="c1">#   patience = 15,</span>
<span class="c1">#   verbose=1,</span>
<span class="c1">#   min_delta=1e-3,</span>
<span class="c1">#   restore_best_weights=True</span>
<span class="c1"># )</span>




<span class="c1">###################################################################################################</span>
<span class="c1"># Model Architecture</span>
<span class="c1">###################################################################################################</span>


<span class="k">def</span> <span class="nf">build_model_tower</span><span class="p">(</span><span class="n">my_model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Build the one of the "tower's" of the siamese network</span>

<span class="sd">    This is the ML model that is deployed to the device.</span>
<span class="sd">    It takes a fingerprint grayscale image as an input</span>
<span class="sd">    and returns a (hopefully) unique signature of the image.</span>
<span class="sd">    """</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))(</span><span class="nb">input</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">'relu'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># This determines how long the fingerprint signature vector is</span>

    <span class="k">return</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">my_model_builder</span><span class="p">(</span><span class="n">my_model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KerasModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Build the siamese network model """</span>
    <span class="n">input_1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
    <span class="n">input_2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="c1"># As mentioned above, Siamese Network share weights between</span>
    <span class="c1"># tower networks (sister networks). To allow this, we will use</span>
    <span class="c1"># same embedding network for both tower networks.</span>
    <span class="n">embedding_network</span> <span class="o">=</span> <span class="n">build_model_tower</span><span class="p">(</span><span class="n">my_model</span><span class="p">)</span>
    <span class="n">tower_1</span> <span class="o">=</span> <span class="n">embedding_network</span><span class="p">(</span><span class="n">input_1</span><span class="p">)</span>
    <span class="n">tower_2</span> <span class="o">=</span> <span class="n">embedding_network</span><span class="p">(</span><span class="n">input_2</span><span class="p">)</span>

    <span class="n">merge_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="n">euclidean_distance</span><span class="p">)([</span><span class="n">tower_1</span><span class="p">,</span> <span class="n">tower_2</span><span class="p">])</span>
    <span class="n">normal_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">merge_layer</span><span class="p">)</span>

    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">"sigmoid"</span><span class="p">)(</span><span class="n">normal_layer</span><span class="p">)</span>
    <span class="n">keras_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">input_1</span><span class="p">,</span> <span class="n">input_2</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output_layer</span><span class="p">)</span>

    <span class="n">keras_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">my_model</span><span class="o">.</span><span class="n">metrics</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">keras_model</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">build_model_function</span> <span class="o">=</span> <span class="n">my_model_builder</span>



<span class="c1">###################################################################################################</span>
<span class="c1"># Dataset generation</span>
<span class="c1">###################################################################################################</span>

<span class="c1"># For every fingerprint in the datset,</span>
<span class="c1"># generate this many non-matching pairs</span>
<span class="n">nomatch_multiplier</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">class_mode</span> <span class="o">=</span> <span class="s1">'binary'</span> <span class="c1"># we have a signal sigmoid output, so must use a binary "class mode"</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'match'</span><span class="p">,</span> <span class="s1">'no-match'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># We manually crop the image in crop_and_convert_from_uint8_to_int8()</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Ths is the size of the images in the dataset,</span>
                                     <span class="c1"># We use the native image size to do all augmentations</span>
                                     <span class="c1"># Then in the preprocessing_function() callback we crop the image border</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">class_weights</span> <span class="o">=</span> <span class="s1">'balanced'</span>


<span class="n">input_shape</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">input_shape</span>
<span class="n">target_size</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">target_size</span>
<span class="n">h_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<span class="n">w_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span>
<span class="k">def</span> <span class="nf">crop_and_convert_from_uint8_to_int8</span><span class="p">(</span><span class="n">params</span><span class="p">:</span><span class="n">ParallelProcessParams</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="c1"># x is a float32 dtype but has an uint8 range</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span> <span class="c1"># The data should already been in the uint8 range, but clip it just to be sure</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">128</span> <span class="c1"># Convert from uint8 to int8</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="c1"># Crop (target_size - input_shape)/2 pixels from the image border</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">h_offset</span><span class="p">:</span><span class="n">target_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">h_offset</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">:</span><span class="n">target_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">w_offset</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="n">my_model</span><span class="o">.</span><span class="n">datagen</span> <span class="o">=</span> <span class="n">ParallelImageDataGenerator</span><span class="p">(</span>
    <span class="n">cores</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="c1"># NOTE: The dtype is float32 but the range is int8,</span>
    <span class="n">max_batches_pending</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
    <span class="n">validation_split</span><span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">validation_augmentation_enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">preprocessing_function</span><span class="o">=</span><span class="n">crop_and_convert_from_uint8_to_int8</span><span class="p">,</span>
    <span class="c1">#save_to_dir=my_model.create_log_dir('datagen_dump', delete_existing=True),</span>
    <span class="n">rotation_range</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">width_shift_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">height_shift_range</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="c1">#brightness_range=(0.50, 1.70),</span>
    <span class="c1">#contrast_range=(0.50, 1.70),</span>
    <span class="n">fill_mode</span><span class="o">=</span><span class="s1">'constant'</span><span class="p">,</span>
    <span class="n">cval</span><span class="o">=</span><span class="mh">0xff</span><span class="p">,</span>
    <span class="n">noise</span><span class="o">=</span><span class="p">[</span><span class="s1">'gauss'</span><span class="p">,</span> <span class="s1">'poisson'</span><span class="p">,</span> <span class="s1">'s&amp;p'</span><span class="p">],</span>
    <span class="c1">#zoom_range=(0.95, 1.05),</span>
    <span class="c1"># samplewise_center=True,</span>
    <span class="c1"># samplewise_std_normalization=True,</span>
    <span class="n">rescale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">horizontal_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vertical_flip</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># NOTE: For privacy purposes, no dataset is provided for this model.</span>
<span class="c1">#       As such, you must generate your own dataset to train this model.</span>
<span class="c1">#       Refer to this model's corresponding tutorial for how to generate the dataset.</span>
<span class="n">DATASET_ARCHIVE_URL</span> <span class="o">=</span> <span class="s1">'your-fingerprint-dataset-directory-or-download-url'</span>
<span class="c1">#DATASET_ARCHIVE_URL = '~/.mltk/fingerprint_reader/dataset'</span>
<span class="n">DATASET_HASH</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">FingerprintSignatureGeneratorDataset</span><span class="p">(</span>
    <span class="n">dataset_path_or_url</span><span class="o">=</span><span class="n">DATASET_ARCHIVE_URL</span><span class="p">,</span>
    <span class="n">dataset_hash</span><span class="o">=</span><span class="n">DATASET_HASH</span><span class="p">,</span>
    <span class="n">nomatch_multiplier</span><span class="o">=</span><span class="n">nomatch_multiplier</span><span class="p">,</span>
    <span class="n">g_filter_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># approximates radius of 2.5</span>
    <span class="n">g_filter_sigma</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
    <span class="n">contrast</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">border</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">balance_threshold_max</span><span class="o">=</span><span class="mi">240</span><span class="p">,</span>
    <span class="n">balance_threshold_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">verify_imin</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
    <span class="n">verify_imax</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span>
    <span class="n">verify_full_threshold</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">verify_center_threshold</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>


<span class="c1">###################################################################################################</span>
<span class="c1"># Model Parameters</span>
<span class="c1">###################################################################################################</span>


<span class="c1"># The maximum "distance" between two signature vectors to be considered</span>
<span class="c1"># the same fingerprint</span>
<span class="c1"># Refer to the &lt;model log dir&gt;/eval/h5/threshold_vs_accuracy.png</span>
<span class="c1"># to get an idea of what this valid should be</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'threshold'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.22</span>

<span class="c1"># Also add the preprocessing settings to the model parameters</span>
<span class="n">preprocess_params</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">preprocess_params</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'sharpen_filter'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sharpen_filter</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'sharpen_filter_width'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sharpen_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'sharpen_filter_height'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sharpen_filter</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'sharpen_gain'</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">sharpen_gain</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'balance_threshold_max'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'balance_threshold_max'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'balance_threshold_min'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'balance_threshold_min'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'border'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'border'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'verify_imin'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'verify_imin'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'verify_imax'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'verify_imax'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'verify_full_threshold'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'verify_full_threshold'</span><span class="p">]</span>
<span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'verify_center_threshold'</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess_params</span><span class="p">[</span><span class="s1">'verify_center_threshold'</span><span class="p">]</span>



<span class="c1">###################################################################################################</span>
<span class="c1"># TF-Lite converter settings</span>
<span class="c1">###################################################################################################</span>

<span class="k">def</span> <span class="nf">my_representative_dataset_generator</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""This is called by the TfliteConverter</span>

<span class="sd">    The data generator returns tuples of fingerprints</span>
<span class="sd">    which is what is required to train the siamese network.</span>
<span class="sd">    However, in my_keras_model_saver() we only save one of the "towers"</span>
<span class="sd">    of the network (which is used to convert the fingerprint into a signature).</span>
<span class="sd">    As such, to quantize the model we need to return a list of fingerprints (not tuples)</span>
<span class="sd">    """</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">my_model</span><span class="o">.</span><span class="n">validation_data</span><span class="p">):</span>
        <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">unpack_x_y_sample_weight</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">batch_x0</span> <span class="o">=</span> <span class="n">batch_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">batch_x1</span> <span class="o">=</span> <span class="n">batch_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># The TF-Lite converter expects 1 sample batches</span>
        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">batch_x0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">batch_x1</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">break</span>


<span class="n">my_model</span><span class="o">.</span><span class="n">tflite_converter</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">optimizations</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">Optimize</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">],</span>
    <span class="n">supported_ops</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">lite</span><span class="o">.</span><span class="n">OpsSet</span><span class="o">.</span><span class="n">TFLITE_BUILTINS_INT8</span><span class="p">],</span>
    <span class="n">inference_input_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
    <span class="n">inference_output_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span>
    <span class="n">representative_dataset</span><span class="o">=</span><span class="n">my_representative_dataset_generator</span><span class="p">,</span>
    <span class="n">experimental_new_converter</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">experimental_new_quantizer</span> <span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>


<span class="c1">###################################################################################################</span>
<span class="c1"># Model Saver</span>
<span class="c1">###################################################################################################</span>


<span class="k">def</span> <span class="nf">my_keras_model_saver</span><span class="p">(</span>
    <span class="n">mltk_model</span><span class="p">:</span><span class="n">MyModel</span><span class="p">,</span>
    <span class="n">keras_model</span><span class="p">:</span><span class="n">KerasModel</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KerasModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""This is invoked after training successfully completes</span>

<span class="sd">    Here want to just save one of the "towers"</span>
<span class="sd">    as that is what is used to generate the fingerprint signature</span>
<span class="sd">    on the device</span>
<span class="sd">    """</span>
    <span class="c1"># The given keras_model contains the full siamese network</span>
    <span class="c1"># Save it to the model's log dir</span>
    <span class="n">h5_path</span> <span class="o">=</span> <span class="n">mltk_model</span><span class="o">.</span><span class="n">h5_log_dir_path</span>
    <span class="n">siamese_network_h5_path</span> <span class="o">=</span> <span class="n">h5_path</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">'.h5'</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">'.siamese.h5'</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Saving </span><span class="si">{</span><span class="n">siamese_network_h5_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">keras_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">siamese_network_h5_path</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">'tf'</span><span class="p">)</span>

    <span class="c1"># Extract the embedding network from the siamese network</span>
    <span class="n">embedding_network</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">'model'</span><span class="p">:</span>
            <span class="n">embedding_network</span> <span class="o">=</span> <span class="n">layer</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">embedding_network</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Failed to find embedding model in siamese network model, does the embedding model have the name "model" ?'</span><span class="p">)</span>

    <span class="c1"># Return the keras model</span>
    <span class="k">return</span> <span class="n">embedding_network</span>

<span class="n">my_model</span><span class="o">.</span><span class="n">on_save_keras_model</span> <span class="o">=</span> <span class="n">my_keras_model_saver</span>



<span class="c1">###################################################################################################</span>
<span class="c1"># Model Evaluation</span>
<span class="c1">###################################################################################################</span>

<span class="k">def</span> <span class="nf">generate_predictions</span><span class="p">(</span>
    <span class="n">mltk_model</span><span class="p">:</span><span class="n">MyModel</span><span class="p">,</span>
    <span class="n">built_model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">KerasModel</span><span class="p">,</span> <span class="n">TfliteModel</span><span class="p">],</span>
    <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Generate predictions using the dataset and trained model</span>

<span class="sd">    A "prediction" is the euclidean distance between two fingerprint images.</span>
<span class="sd">    If the distance is less than threshold then the fingerprints are considered</span>
<span class="sd">    a match, otherwise they're not matching (i.e. they're not the same finger)</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">_compare_signatures</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># Calculate the distance (i.e. similarity)</span>
        <span class="c1"># between the two fingerprint signature vectors</span>
        <span class="n">dis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)))</span>
        <span class="c1"># If the distance is less than the threshold</span>
        <span class="c1"># then the two signatures are considered a match</span>
        <span class="c1"># Normalize the distance to be between 0,1</span>
        <span class="c1"># where &lt;0.5 maps to &lt; threshold</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">((</span><span class="mf">0.5</span><span class="o">/</span><span class="n">threshold</span><span class="p">)</span> <span class="o">*</span> <span class="n">dis</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">dis</span>

    <span class="n">y_dis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_label</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="s1">'    Generating .h5 predictions'</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">built_model</span><span class="p">,</span> <span class="n">KerasModel</span><span class="p">)</span> <span class="k">else</span> <span class="s1">'Generating .tflite predictions'</span>

    <span class="c1"># If this a .tflite model</span>
    <span class="c1"># then we need to dequantize the model output.</span>
    <span class="c1"># The input to the .tflite should have a scaler of 1 and zeropoint of 0</span>
    <span class="c1"># (i.e. the model input expects the full int8 range)</span>
    <span class="c1"># However, the model output does NOT use the full int8.</span>
    <span class="c1"># Thus we need to use the output tensor's scaler and zeropoint to convert to the int8 range.</span>
    <span class="c1"># HINT: look at the the .tflite in https://netron.app</span>
    <span class="c1">#      and view the quantization params for the input and output tensors.</span>
    <span class="c1"># The TfliiteModel.predict() API will automatically do the de-quantization if</span>
    <span class="c1"># we force the output dtype to be float32</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">built_model</span><span class="p">,</span> <span class="n">TfliteModel</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">'y_dtype'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'prediction'</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span> <span class="k">as</span> <span class="n">progbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="c1"># For each fingerprint sample pair</span>
                <span class="c1"># generate a "signature"</span>
                <span class="n">s0</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pred</span><span class="p">,</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">_compare_signatures</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
                <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                <span class="n">y_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>
                <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">mltk_model</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'prediction'</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span> <span class="k">as</span> <span class="n">progbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">mltk_model</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
                <span class="n">batch_x0</span> <span class="o">=</span> <span class="n">batch_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">batch_x1</span> <span class="o">=</span> <span class="n">batch_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">batch_s0</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch_x0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">batch_s1</span> <span class="o">=</span> <span class="n">built_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch_x1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_s0</span><span class="p">,</span> <span class="n">batch_s1</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">):</span>
                    <span class="n">pred</span><span class="p">,</span> <span class="n">dis</span> <span class="o">=</span> <span class="n">_compare_signatures</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
                    <span class="n">y_pred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                    <span class="n">y_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>
                    <span class="n">y_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mltk_model</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">y_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_dis</span>


<span class="k">def</span> <span class="nf">collect_samples</span><span class="p">(</span><span class="n">my_model</span><span class="p">:</span><span class="n">MyModel</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Collect the specified number of samples from the dataset"""</span>
    <span class="n">my_model</span><span class="o">.</span><span class="n">datagen</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">my_model</span><span class="o">.</span><span class="n">datagen</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">my_model</span><span class="o">.</span><span class="n">datagen</span><span class="o">.</span><span class="n">validation_split</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">my_model</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">'training'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mf">1e12</span>

    <span class="n">match_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nomatch_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span> <span class="ow">in</span> <span class="n">my_model</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_samples</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">nomatch_samples</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch_y</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">match_samples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nomatch_samples</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">nomatch_samples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">))</span>

    <span class="n">my_model</span><span class="o">.</span><span class="n">unload_dataset</span><span class="p">()</span>

    <span class="n">all_x</span> <span class="o">=</span> <span class="n">match_samples</span> <span class="o">+</span> <span class="n">nomatch_samples</span>
    <span class="n">all_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_samples</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nomatch_samples</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_x</span><span class="p">,</span> <span class="n">all_y</span>


<span class="k">def</span> <span class="nf">my_model_evaluator</span><span class="p">(</span>
    <span class="n">mltk_model</span><span class="p">:</span><span class="n">MyModel</span><span class="p">,</span>
    <span class="n">built_model</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">KerasModel</span><span class="p">,</span> <span class="n">TfliteModel</span><span class="p">],</span>
    <span class="n">eval_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
    <span class="n">show</span><span class="p">:</span><span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EvaluationResults</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Custom callback to evaluate the trained model</span>

<span class="sd">    The model is effectively a classifier, but we need to do</span>
<span class="sd">    a special step to compare the signatures in the dataset.</span>
<span class="sd">    """</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">ClassifierEvaluationResults</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">mltk_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">classes</span><span class="o">=</span><span class="n">mltk_model</span><span class="o">.</span><span class="n">classes</span>
    <span class="p">)</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'threshold'</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Using model threshold: </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">y_pred</span><span class="p">,</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">y_dis</span> <span class="o">=</span> <span class="n">generate_predictions</span><span class="p">(</span>
        <span class="n">mltk_model</span><span class="p">,</span>
        <span class="n">built_model</span><span class="p">,</span>
        <span class="n">threshold</span>
    <span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">generate_plots</span><span class="p">(</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="n">eval_dir</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="n">show</span>
    <span class="p">)</span>

    <span class="n">match_dis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nomatch_dis</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">dis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_label</span><span class="p">,</span> <span class="n">y_dis</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">match_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nomatch_dis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dis</span><span class="p">)</span>

    <span class="n">match_dis</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">match_dis</span><span class="p">)</span>
    <span class="n">match_dis_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match_dis</span><span class="p">))]</span>
    <span class="n">nomatch_dis</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nomatch_dis</span><span class="p">)</span>
    <span class="n">nomatch_dis_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nomatch_dis</span><span class="p">))]</span>

    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">match_dis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">match_dis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">match_dis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">match_dis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">step</span><span class="p">)</span>

    <span class="n">match_acc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nomatch_acc</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">thres</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
        <span class="n">valid_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">thres</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">match_dis</span><span class="p">)</span>
        <span class="n">match_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_dis</span><span class="p">))</span>
        <span class="n">valid_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">thres</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nomatch_dis</span><span class="p">)</span>
        <span class="n">nomatch_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nomatch_dis</span><span class="p">))</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">'Threshold vs Accuracy'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">match_acc</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Match'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nomatch_acc</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Non-match'</span><span class="p">)</span>

    <span class="c1">#plt.ylim([0.0, 0.01])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"lower right"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Accuracy'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Threshold'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Threshold vs Accuracy'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">'major'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_dir</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">eval_dir</span><span class="si">}</span><span class="s1">/threshold_vs_accuracy.png'</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Generated </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">'Euclidean Distance'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">match_dis_x</span><span class="p">,</span> <span class="n">match_dis</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Match'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nomatch_dis_x</span><span class="p">,</span> <span class="n">nomatch_dis</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Non-match'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"lower right"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Index'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Distance'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Euclidean Distance'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">'major'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eval_dir</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">eval_dir</span><span class="si">}</span><span class="s1">/eclidean_distance.png'</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Generated </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>


<span class="n">my_model</span><span class="o">.</span><span class="n">eval_custom_function</span> <span class="o">=</span> <span class="n">my_model_evaluator</span>




<span class="c1">###################################################################################################</span>
<span class="c1"># Custom model commands</span>
<span class="c1">###################################################################################################</span>


<span class="nd">@my_model</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">'dump'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">datagen_dump_custom_command</span><span class="p">(</span>
    <span class="n">tflite</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">'--tflite'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Include the trained .tflite model predictions in the displayed results'</span>
    <span class="p">),</span>
    <span class="n">h5</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">'--h5'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Include the trained .h5 model predictions in the displayed results'</span>
    <span class="p">),</span>
    <span class="n">count</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">'--count'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Number of samples to dump, -1 to dump all'</span>
    <span class="p">),</span>
    <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'--threshold'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Comparsion threshold. If omitted then use the threshold from the model'</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Custom command to dump the dataset</span>

<span class="sd">    \b</span>
<span class="sd">    Invoke this command with:</span>
<span class="sd">    mltk custom fingerprint_signature_generator dump</span>
<span class="sd">    mltk custom fingerprint_signature_generator dump --tflite --h5 --count 200</span>
<span class="sd">    """</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="n">my_model</span><span class="o">.</span><span class="n">model_parameters</span><span class="p">[</span><span class="s1">'threshold'</span><span class="p">]</span>


    <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">create_log_dir</span><span class="p">(</span><span class="s1">'datagen_dump'</span><span class="p">,</span> <span class="n">delete_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">x_samples</span><span class="p">,</span> <span class="n">y_samples</span> <span class="o">=</span> <span class="n">collect_samples</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>

    <span class="n">tflite_y_pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">tflite</span><span class="p">:</span>
        <span class="n">tflite_model</span> <span class="o">=</span> <span class="n">load_tflite_or_keras_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">'tflite'</span><span class="p">)</span>
        <span class="n">tflite_y_pred</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_predictions</span><span class="p">(</span>
            <span class="n">my_model</span><span class="p">,</span>
            <span class="n">tflite_model</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_samples</span>
        <span class="p">)</span>

    <span class="n">h5_y_pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">h5</span><span class="p">:</span>
        <span class="n">keras_model</span> <span class="o">=</span> <span class="n">load_tflite_or_keras_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s1">'h5'</span><span class="p">)</span>
        <span class="n">h5_y_pred</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_predictions</span><span class="p">(</span>
            <span class="n">my_model</span><span class="p">,</span>
            <span class="n">keras_model</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_samples</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x_samples</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'sample'</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'               Dumping samples'</span><span class="p">)</span> <span class="k">as</span> <span class="n">progbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_samples</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="s1">'match'</span> <span class="k">if</span> <span class="n">y_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">'nomatch'</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">'Match:'</span> <span class="k">if</span> <span class="n">y_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">'Non-match:'</span>
            <span class="k">if</span> <span class="n">tflite_y_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' tflite=</span><span class="si">{</span><span class="n">tflite_y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">,'</span>
            <span class="k">if</span> <span class="n">h5_y_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">' keras=</span><span class="si">{</span><span class="n">h5_y_pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">,'</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dump_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.png'</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Images dumped to </span><span class="si">{</span><span class="n">dump_dir</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>


<span class="nd">@my_model</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s1">'preprocess'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">preprocess_custom_command</span><span class="p">(</span>
    <span class="n">count</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">'--count'</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">'Number of samples to dump, -1 to use all images'</span>
    <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Compare raw samples vs preprocessed samples</span>

<span class="sd">    \b</span>
<span class="sd">    Invoke this command with:</span>
<span class="sd">    mltk custom fingerprint_signature_generator preprocess</span>
<span class="sd">    mltk custom fingerprint_signature_generator preprocess --count 200</span>
<span class="sd">    """</span>

    <span class="n">dump_dir</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">create_log_dir</span><span class="p">(</span><span class="s1">'compare_preprocess'</span><span class="p">,</span> <span class="n">delete_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">my_model</span><span class="o">.</span><span class="n">dataset</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">preprocess_samples_enabled</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">unprocessed_dir</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
    <span class="n">all_samples</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">list_all_samples</span><span class="p">(</span><span class="n">unprocessed_dir</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_samples</span><span class="p">)</span>
    <span class="n">all_samples</span> <span class="o">=</span> <span class="n">all_samples</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_samples</span><span class="p">))]</span>


    <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_samples</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'sample'</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">'Comparing samples'</span><span class="p">)</span> <span class="k">as</span> <span class="n">progbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">all_samples</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">unprocessed_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">color_mode</span><span class="o">=</span><span class="s1">'grayscale'</span><span class="p">)</span>
            <span class="n">unprocessed_img</span> <span class="o">=</span> <span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint8'</span><span class="p">)</span>
            <span class="n">unprocessed_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">unprocessed_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">processed_img</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">unprocessed_img</span><span class="p">)</span>

            <span class="n">img_valid</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">verify_sample</span><span class="p">(</span><span class="n">processed_img</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">unprocessed_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">processed_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

            <span class="c1">#fig.tight_layout()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">previous_verify_msg</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">dump_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="s2">""</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">img_valid</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">"droppped-"</span><span class="si">}{</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Images dumped to </span><span class="si">{</span><span class="n">dump_dir</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>


<span class="c1">##########################################################################################</span>
<span class="c1"># The following allows for running this model training script directly, e.g.:</span>
<span class="c1"># python fingerprint_signature_generator.py</span>
<span class="c1">#</span>
<span class="c1"># Note that this has the same functionality as:</span>
<span class="c1"># mltk train fingerprint_signature_generator</span>
<span class="c1">#</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mltk.core</span> <span class="k">as</span> <span class="nn">mltk_core</span>
    <span class="kn">from</span> <span class="nn">mltk</span> <span class="kn">import</span> <span class="n">cli</span>

    <span class="c1"># Setup the CLI logger</span>
    <span class="n">cli</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># If this is true then this will do a "dry run" of the model testing</span>
    <span class="c1"># If this is false, then the model will be fully trained</span>
    <span class="n">test_mode_enabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Train the model</span>
    <span class="c1"># This does the same as issuing the command: mltk train fingerprint_signature_generator-test --clean</span>
    <span class="n">train_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">train_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">train_results</span><span class="p">)</span>

    <span class="c1"># Evaluate the model against the quantized .h5 (i.e. float32) model</span>
    <span class="c1"># This does the same as issuing the command: mltk evaluate fingerprint_signature_generator-test</span>
    <span class="n">tflite_eval_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">evaluate_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tflite_eval_results</span><span class="p">)</span>

    <span class="c1"># Profile the model in the simulator</span>
    <span class="c1"># This does the same as issuing the command: mltk profile fingerprint_signature_generator-test</span>
    <span class="n">profiling_results</span> <span class="o">=</span> <span class="n">mltk_core</span><span class="o">.</span><span class="n">profile_model</span><span class="p">(</span><span class="n">my_model</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test_mode_enabled</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">profiling_results</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </article>
        </div>
      </div>
      <a href="#" class="go-top"><i class="md-icon">arrow_upward</i>Back to Top</a>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="rock_paper_scissors.html" title="rock_paper_scissors"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> rock_paper_scissors </span>
              </div>
            </a>
          
          
            <a href="../tinyml/index.html" title="TinyML Models"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> TinyML Models </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2023, Silicon Labs.
              
          </div>
            Last updated on
              Mar 01, 2023.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
        <button id="survey-link" class="feedback-button">Feedback</button>
      </div>
    </div>
  </footer>
  <div class="privacy-banner">
    <div class="privacy-banner-wrapper">
      <p>
        <b>Important:</b> We use cookies only for functional and traffic analytics. <br />
        We DO NOT use cookies for any marketing purposes. By using our site you acknowledge you have read and understood our <a class="privacy-policy" href="https://www.silabs.com/about-us/legal/cookie-policy" target="_blank">Cookie Policy</a>.
      </p>
      <a class="privacy-banner-accept" href="#">Got it</a>
    </div>
</div>
  
<div class="survey-container" id="dlg-survey"> 
    <div class="close" id="dlg-survey-close"><i class="md-icon">close</i></div>
    <div class="msg">Please click the <b>submit</b> button at the end even if you do not answer all of the questions</div>
    <iframe id="iframe-survey" style="width: 100%; height: 100%;"></iframe>
</div>
  
  <script src="../../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>